<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>7. Browser Events &mdash; A Modern Introduction to Programming with JavaScript and jQuery</title>
    
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1st Edition',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="top" title="A Modern Introduction to Programming with JavaScript and jQuery" href="index.html" />
    <link rel="next" title="8. HTTP requests" href="ch08.html" />
    <link rel="prev" title="6. The Document-Object Model" href="ch06.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ch08.html" title="8. HTTP requests"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ch06.html" title="6. The Document-Object Model"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">A Modern Introduction to Programming with JavaScript and jQuery</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="browser-events">
<span id="browser-events-chapter"></span><h1>7. Browser Events<a class="headerlink" href="#browser-events" title="Permalink to this headline">¶</a></h1>
<p>To add interesting functionality to a web-page, just being able to inspect or
modify the document is generally not enough. We also need to be able to detect
what the user is doing, and respond to it. For this, we will use a thing called
event handlers. Pressed keys are events, mouse clicks are events, even mouse
motion can be seen as a series of events. In <a class="reference internal" href="ch05.html#web-programming-chapter"><em>Web programming: A crash course</em></a>, we
added an <tt class="docutils literal"><span class="pre">onclick</span></tt> property to a button, in order to do something when it was
pressed. This is a simple event handler.</p>
<p>The way browser events work is, fundamentally, very simple. It is possible to
register handlers for specific event types and specific DOM nodes. Whenever an
event occurs, the handler for that event, if any, is called. For some events,
such as key presses, knowing just that the event occurred is not good enough,
you also want to know which key was pressed. To store such information, every
event creates an event object, which the handler can look at.</p>
<p>It is important to realise that, even though events can fire at any time, no
two handlers ever run at the same moment. If other JavaScript code is still
running, the browser waits until it finishes before it calls the next handler.
This also holds for code that is triggered in other ways, such as with
<tt class="docutils literal"><span class="pre">setTimeout</span></tt>. In programmer jargon, browser JavaScript is single-threaded,
there are never two &#8216;threads&#8217; running at the same time. This is, in most cases,
a good thing. It is very easy to get strange results when multiple things
happen at the same time.</p>
<p>An event, when not handled, can &#8216;bubble&#8217; through the DOM tree. What this means
is that if you click on, for example, a link in a paragraph, any handlers
associated with the link are called first.  If there are no such handlers, or
these handlers do not indicate that they have finished handling the event, the
handlers for the paragraph, which is the parent of the link, are tried. After
that, the handlers for <tt class="docutils literal"><span class="pre">document.body</span></tt> get a turn. Finally, if no JavaScript
handlers have taken care of the event, the browser handles it. When clicking a
link, this means that the link will be followed.</p>
<hr class="docutils" />
<p>So, as you see, events are easy. The only hard thing about them is that
browsers, while all supporting more or less the same functionality, support
this functionality through different interfaces. As usual, the most
incompatible browser is Internet Explorer, which ignores the standard that most
other browsers follow. After that, there is Opera, which does not properly
support some useful events, such as the <tt class="docutils literal"><span class="pre">onunload</span></tt> event which fires when
leaving a page, and sometimes gives confusing information about keyboard
events.</p>
<p>There are four event-related actions one might want to take.</p>
<ul class="simple">
<li>Registering an event handler.</li>
<li>Getting the event object.</li>
<li>Extracting information from this object.</li>
<li>Signalling that an event has been handled.</li>
</ul>
<p>None of them work the same across all major browsers.</p>
<hr class="docutils" />
<p>As a practice field for our event-handling, we open a document with
a button and a text field. Keep this window open (and attached) for
the rest of the chapter.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">attach</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;example_events.html&quot;</span><span class="p">));</span>
</pre></div>
</div>
<hr class="docutils" />
<p>The first action, registering a handler, can be done by setting an element&#8217;s
<tt class="docutils literal"><span class="pre">onclick</span></tt> (or <tt class="docutils literal"><span class="pre">onkeypress</span></tt>, and so on) property. This does in fact work
across browsers, but it has an important drawback ― you can only attach one
handler to an element. Most of the time, one is enough, but there are cases,
especially when a program has to be able to work together with other programs
(which might also be adding handlers), that this is annoying.</p>
<p>In Internet Explorer, one can add a click handler to a button like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">).</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;onclick&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">print</span><span class="p">(</span><span class="s2">&quot;Click!&quot;</span><span class="p">);});</span>
</pre></div>
</div>
<p>On the other browsers, it goes like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">print</span><span class="p">(</span><span class="s2">&quot;Click!&quot;</span><span class="p">);},</span>
                             <span class="kc">false</span><span class="p">);</span>
</pre></div>
</div>
<p>Note how <tt class="docutils literal"><span class="pre">&quot;on&quot;</span></tt> is left off in the second case. The third argument to
<tt class="docutils literal"><span class="pre">addEventListener</span></tt>, <tt class="docutils literal"><span class="pre">false</span></tt>, indicates that the event should &#8220;bubble&#8221;
through the DOM tree as normal. Giving <tt class="docutils literal"><span class="pre">true</span></tt> instead can be used to give
this handler priority over the handlers &#8216;beneath&#8217; it, but since Internet
Explorer does not support such a thing, this is rarely useful.</p>
<hr class="docutils" />
<p>Removing events works very much like adding them, but this time the methods
<tt class="docutils literal"><span class="pre">detachEvent</span></tt> and <tt class="docutils literal"><span class="pre">removeEventListener</span></tt> are used. Note that, to remove a
handler, you need to have access to the function you attached to it.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Exceptions produced by event handlers can, because of technical limitations,
not be caught by the console. Thus, they are handled by the browser, which
might mean they get hidden in some kind of &#8220;error console&#8221; somewhere, or cause
a message to pop up. When you write an event handler and it does not seem to
work, it might be silently aborting because it causes some kind of error.</p>
<hr class="docutils" />
<p>Most browsers pass the event object as an argument to the handler.  Internet
Explorer stores it in the top-level variable called <tt class="docutils literal"><span class="pre">event</span></tt>. When looking at
JavaScript code, you will often come across something like <tt class="docutils literal"><span class="pre">event</span> <span class="pre">||</span>
<span class="pre">window.event</span></tt>, which takes the local variable <tt class="docutils literal"><span class="pre">event</span></tt> or, if that is
undefined, the top-level variable by that same name.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">showEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">show</span><span class="p">(</span><span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">registerEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">showEvent</span><span class="p">);</span>
</pre></div>
</div>
<p>Type a few characters in the field, look at the objects, and shut it up again:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">showEvent</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>When the user clicks his mouse, three events are generated. First
<tt class="docutils literal"><span class="pre">mousedown</span></tt>, at the moment the mouse button is pressed. Then, <tt class="docutils literal"><span class="pre">mouseup</span></tt>, at
the moment it is released. And finally, <tt class="docutils literal"><span class="pre">click</span></tt>, to indicate something was
clicked. When this happens two times in quick succession, a <tt class="docutils literal"><span class="pre">dblclick</span></tt>
(double-click) event is also generated. Note that it is possible for the
<tt class="docutils literal"><span class="pre">mousedown</span></tt> and <tt class="docutils literal"><span class="pre">mouseup</span></tt> events to happen some time apart ― when the mouse
button is held for a while.</p>
<p>When you attach an event handler to, for example, a button, the fact that it
has been clicked is often all you need to know. When the handler, on the other
hand, is attached to a node that has children, clicks from the children will
&#8216;bubble&#8217; up to it, and you will want to find out which child has been clicked.
For this purpose, event objects have a property called <tt class="docutils literal"><span class="pre">target</span></tt>... or
<tt class="docutils literal"><span class="pre">srcElement</span></tt>, depending on the browser.</p>
<p>Another interesting piece of information are the precise coordinates at which
the click occurred. Event objects related to the mouse contain <tt class="docutils literal"><span class="pre">clientX</span></tt> and
<tt class="docutils literal"><span class="pre">clientY</span></tt> properties, which give the <tt class="docutils literal"><span class="pre">x</span></tt> and <tt class="docutils literal"><span class="pre">y</span></tt> coordinates of the
mouse, in pixels, on the screen. Documents can scroll, though, so often these
coordinates do not tell us much about the part of the document that the mouse
is over. Some browsers provide <tt class="docutils literal"><span class="pre">pageX</span></tt> and <tt class="docutils literal"><span class="pre">pageY</span></tt> properties for this
purpose, but others (guess which) do not.  Fortunately, the information about
the amount of pixels the document has been scrolled can be found in
<tt class="docutils literal"><span class="pre">document.body.scrollLeft</span></tt> and <tt class="docutils literal"><span class="pre">document.body.scrollTop</span></tt>.</p>
<p>This handler, attached to the whole document, intercepts all mouse clicks, and
prints some information about them.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">reportClick</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span> <span class="o">||</span> <span class="nx">event</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pageX</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">pageY</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pageX</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pageX</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
        <span class="nx">pageY</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Mouse clicked at &quot;</span><span class="p">,</span> <span class="nx">pageX</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="nx">pageY</span><span class="p">,</span> <span class="s2">&quot;. Inside element:&quot;</span><span class="p">);</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">registerEventHandler</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">reportClick</span><span class="p">);</span>
</pre></div>
</div>
<p>And get rid of it again:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">reportClick</span><span class="p">);</span>
</pre></div>
</div>
<p>Obviously, writing all these checks and workarounds is not something you want
to do in every single event handler. In a moment, after we have gotten
acquainted with a few more incompatibilities, we will write a function to
&#8220;normalise&#8221; event objects to work the same across browsers.</p>
<p>It is also sometimes possible to find out which mouse button was pressed, using
the <tt class="docutils literal"><span class="pre">which</span></tt> and <tt class="docutils literal"><span class="pre">button</span></tt> properties of event objects. Unfortunately, this
is very unreliable ― some browsers pretend mouses have only one button, others
report right-clicks as clicks during which the control key was held down, and
so on.</p>
<hr class="docutils" />
<p>Apart from clicks, we might also be interested in the movement of the mouse.
The <tt class="docutils literal"><span class="pre">mousemove</span></tt> event of a DOM node is fired whenever the mouse moves while
it is over that element. There are also <tt class="docutils literal"><span class="pre">mouseover</span></tt> and <tt class="docutils literal"><span class="pre">mouseout</span></tt>, which
are fired only when the mouse enters or leaves a node. For events of this last
type, the <tt class="docutils literal"><span class="pre">target</span></tt> (or <tt class="docutils literal"><span class="pre">srcElement</span></tt>) property points at the node that the
event is fired for, while the <tt class="docutils literal"><span class="pre">relatedTarget</span></tt> (or <tt class="docutils literal"><span class="pre">toElement</span></tt>, or
<tt class="docutils literal"><span class="pre">fromElement</span></tt>) property gives the node that the mouse came from (for
<tt class="docutils literal"><span class="pre">mouseover</span></tt>) or left to (for <tt class="docutils literal"><span class="pre">mouseout</span></tt>).</p>
<p><tt class="docutils literal"><span class="pre">mouseover</span></tt> and <tt class="docutils literal"><span class="pre">mouseout</span></tt> can be tricky when they are registered on an
element that has child nodes. Events fired for the child nodes will bubble up
to the parent element, so you will also see a <tt class="docutils literal"><span class="pre">mouseover</span></tt> event when the
mouse enters one of the child nodes. The <tt class="docutils literal"><span class="pre">target</span></tt> and <tt class="docutils literal"><span class="pre">relatedTarget</span></tt>
properties can be used to detect (and ignore) such events.</p>
<hr class="docutils" />
<p>For every key that the user presses, three events are generated: <tt class="docutils literal"><span class="pre">keydown</span></tt>,
<tt class="docutils literal"><span class="pre">keyup</span></tt>, and <tt class="docutils literal"><span class="pre">keypress</span></tt>. In general, you should use the first two in cases
where you really want to know which key was pressed, for example when you want
to do something when the arrow keys are pressed. <tt class="docutils literal"><span class="pre">keypress</span></tt>, on the other
hand, is to be used when you are interested in the character that is being
typed.  The reason for this is that there is often no character information in
<tt class="docutils literal"><span class="pre">keyup</span></tt> and <tt class="docutils literal"><span class="pre">keydown</span></tt> events, and Internet Explorer does not generate a
<tt class="docutils literal"><span class="pre">keypress</span></tt> event at all for special keys such as the arrow keys.</p>
<p>Finding out which key was pressed can be quite a challenge by itself. For
<tt class="docutils literal"><span class="pre">keydown</span></tt> and <tt class="docutils literal"><span class="pre">keyup</span></tt> events, the event object will have a <tt class="docutils literal"><span class="pre">keyCode</span></tt>
property, which contains a number. Most of the time, these codes can be used to
identify keys in a reasonably browser-independant way. Finding out which code
corresponds to which key can be done by simple experiments...</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">printKeyCode</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Key &quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="s2">&quot; was pressed.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">registerEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">printKeyCode</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">printKeyCode</span><span class="p">);</span>
</pre></div>
</div>
<p>In most browsers, a single key code corresponds to a single <em>physical</em> key on
your keyboard. The Opera browser, however, will generate different key codes
for some keys depending on whether shift is pressed or not. Even worse, some of
these shift-is-pressed codes are the same codes that are also used for other
keys ― shift-9, which on most keyboards is used to type a parenthesis, gets the
same code as the down arrow, and as such is hard to distinguish from it. When
this threatens to sabotage your programs, you can usually resolve it by
ignoring key events that have shift pressed.</p>
<p>To find out whether the shift, control, or alt key was held during a key or
mouse event, you can look at the <tt class="docutils literal"><span class="pre">shiftKey</span></tt>, <tt class="docutils literal"><span class="pre">ctrlKey</span></tt>, and <tt class="docutils literal"><span class="pre">altKey</span></tt>
properties of the event object.</p>
<p>For <tt class="docutils literal"><span class="pre">keypress</span></tt> events, you will want to know which character was typed. The
event object will have a <tt class="docutils literal"><span class="pre">charCode</span></tt> property, which, if you are lucky,
contains the Unicode number corresponding to the character that was typed,
which can be converted to a 1-character string by using
<tt class="docutils literal"><span class="pre">String.fromCharCode</span></tt>. Unfortunately, some browsers do not define this
property, or define it as <tt class="docutils literal"><span class="pre">0</span></tt>, and store the character code in the
<tt class="docutils literal"><span class="pre">keyCode</span></tt> property instead.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">printCharacter</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">charCode</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">charCode</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Character &#39;&quot;</span><span class="p">,</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">charCode</span><span class="p">),</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">registerEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">printCharacter</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">printCharacter</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>An event handler can &#8216;stop&#8217; the event it is handling. There are two different
ways to do this. You can prevent the event from bubbling up to parent nodes and
the handlers defined on those, and you can prevent the browser from taking the
standard action associated with such an event. It should be noted that browsers
do not always follow this ― preventing the default behaviour for the pressing
of certain &#8220;hotkeys&#8221; will, on many browsers, not actually keep the browser from
executing the normal effect of these keys.</p>
<p>On most browsers, stopping event bubbling is done with the <tt class="docutils literal"><span class="pre">stopPropagation</span></tt>
method of the event object, and preventing default behaviour is done with the
<tt class="docutils literal"><span class="pre">preventDefault</span></tt> method. For Internet Explorer, this is done by setting the
<tt class="docutils literal"><span class="pre">cancelBubble</span></tt> property of this object to <tt class="docutils literal"><span class="pre">true</span></tt>, and the <tt class="docutils literal"><span class="pre">returnValue</span></tt>
property to <tt class="docutils literal"><span class="pre">false</span></tt>, respectively.</p>
<p>And that was the last of the long list of incompatibilities that we will
discuss in this chapter. Which means that we can finally write the event
normaliser function and move on to more interesting things.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">normaliseEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;};</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">srcElement</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">event</span><span class="p">.</span><span class="nx">toElement</span> <span class="o">||</span> <span class="nx">event</span><span class="p">.</span><span class="nx">fromElement</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">)</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">relatedTarget</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">toElement</span> <span class="o">||</span> <span class="nx">event</span><span class="p">.</span><span class="nx">fromElement</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;keypress&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">charCode</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">event</span><span class="p">.</span><span class="nx">charCode</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">charCode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A <tt class="docutils literal"><span class="pre">stop</span></tt> method is added, which cancels both the bubbling and the default
action of the event. Some browsers already provide this, in which case we leave
it as it is.</p>
<p>Next we can write convenient wrappers for <tt class="docutils literal"><span class="pre">registerEventHandler</span></tt> and
<tt class="docutils literal"><span class="pre">unregisterEventHandler</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">addHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">wrapHandler</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="p">(</span><span class="nx">normaliseEvent</span><span class="p">(</span><span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">registerEventHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">wrapHandler</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">node</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">wrapHandler</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeHandler</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">unregisterEventHandler</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">blockQ</span> <span class="o">=</span> <span class="nx">addHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">character</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The new <tt class="docutils literal"><span class="pre">addHandler</span></tt> function wraps the handler function it is given in a new
function, so it can take care of normalising the event objects. It returns an
object that can be given to <tt class="docutils literal"><span class="pre">removeHandler</span></tt> when we want to remove this
specific handler. Try typing a &#8216;<tt class="docutils literal"><span class="pre">q</span></tt>&#8216; in the text field.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">blockQ</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Armed with <tt class="docutils literal"><span class="pre">addHandler</span></tt> and the <tt class="docutils literal"><span class="pre">dom</span></tt> function from the last chapter, we
are ready for more challenging feats of document-manipulation. As an exercise,
we will implement the game known as Sokoban. This is something of a classic,
but you may not have seen it before. The rules are this: There is a grid, made
up of walls, empty space, and one or more &#8220;exits&#8221;. On this grid, there are a
number of crates or stones, and a little dude that the player controls. This
dude can be moved horizontally and vertically into empty squares, and can push
the boulders around, provided that there is empty space behind them. The goal
of the game is to move a given number of boulders into the exits.</p>
<p>Just like the terraria from <a class="reference internal" href="ch11.html#oop-chapter"><em>Object-oriented Programming</em></a>, a Sokoban level can be
represented as text. The variable <tt class="docutils literal"><span class="pre">sokobanLevels</span></tt>, in the
<tt class="docutils literal"><span class="pre">example_events.html</span></tt> window, contains an array of level objects. Each level
has a property <tt class="docutils literal"><span class="pre">field</span></tt>, containing a textual representation of the level, and
a property <tt class="docutils literal"><span class="pre">boulders</span></tt>, indicating the amount of boulders that must be
expelled to finish the level.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">alert</span><span class="p">(</span><span class="nx">sokobanLevels</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">sokobanLevels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">boulders</span><span class="p">);</span>
<span class="nx">forEach</span><span class="p">(</span><span class="nx">sokobanLevels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">field</span><span class="p">,</span> <span class="nx">print</span><span class="p">);</span>
</pre></div>
</div>
<p>In such a level, the <tt class="docutils literal"><span class="pre">#</span></tt> characters are walls, spaces are empty squares,
<tt class="docutils literal"><span class="pre">0</span></tt> characters are used for for boulders, an <tt class="docutils literal"><span class="pre">&#64;</span></tt> for the starting location
of the player, and a <tt class="docutils literal"><span class="pre">*</span></tt> for the exit.</p>
<hr class="docutils" />
<p>But, when playing the game, we do not want to be looking at this textual
representation. Instead, we will put a table into the document. I made small
style-sheet (<a class="reference external" href="css/sokoban.css">sokoban.css</a>, if you are curious what it looks
like) to give the cells of this table a fixed square size, and added it to the
example document. Each of the cells in this table will get a background image,
representing the type of the square (empty, wall, or exit). To show the
location of the player and the boulders, images are added to these table cells,
and moved to different cells as appropriate.</p>
<p>It would be possible to use this table as the main representation of our data ―
when we want to look whether there is a wall in a given square, we just inspect
the background of the appropriate table cell, and to find the player, we just
search for the image node with the correct <tt class="docutils literal"><span class="pre">src</span></tt> property. In some cases,
this approach is practical, but for this program I chose to keep a separate
data structure for the grid, because it makes things much more straightforward.</p>
<p>This data structure is a two-dimensional grid of objects, representing the
squares of the playing field. Each of the objects must store the type of
background it has and whether there is a boulder or player present in that
cell. It should also contain a reference to the table cell that is used to
display it in the document, to make it easy to move images in and out of this
table cell.</p>
<p>That gives us two kinds of objects ― one to hold the grid of the playing field,
and one to represent the individual cells in this grid. If we want the game to
also do things like moving the next level at the appropriate moment, and being
able to reset the current level when you mess up, we will also need a
&#8220;controller&#8221; object, which creates or removes the field objects at the
appropriate moment. For convenience, we will be using the prototype approach
outlined at the end of <a class="reference internal" href="ch11.html#oop-chapter"><em>Object-oriented Programming</em></a>, so object types are just prototypes,
and the <tt class="docutils literal"><span class="pre">create</span></tt> method, rather than the <tt class="docutils literal"><span class="pre">new</span></tt> operator, is used to make
new objects.</p>
<hr class="docutils" />
<p>Let us start with the objects representing the squares of the game&#8217;s field.
They are responsible for setting the background of their cells correctly, and
adding images as appropriate. The <tt class="docutils literal"><span class="pre">img/sokoban/</span></tt> directory contains a set of
images, based on another ancient game, which will be used to visualise the
game. For a start, the <tt class="docutils literal"><span class="pre">Square</span></tt> prototype could look like this.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Square</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">character</span><span class="p">,</span> <span class="nx">tableCell</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s2">&quot;wall&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s2">&quot;exit&quot;</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">tableCell</span> <span class="o">=</span> <span class="nx">tableCell</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tableCell</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">background</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s2">&quot;boulder&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s2">&quot;player&quot;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;IMG&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">src</span><span class="o">:</span> <span class="s2">&quot;img/sokoban/&quot;</span> <span class="o">+</span>
                                            <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">+</span> <span class="s2">&quot;.gif&quot;</span><span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tableCell</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">hasPlayer</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">==</span> <span class="s2">&quot;player&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">hasBoulder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">==</span> <span class="s2">&quot;boulder&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">background</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">isExit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">background</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">testSquare</span> <span class="o">=</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;TD&quot;</span><span class="p">));</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">testSquare</span><span class="p">.</span><span class="nx">hasPlayer</span><span class="p">());</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">character</span></tt> argument to the constructor will be used to transform
characters from the level blueprints into actual <tt class="docutils literal"><span class="pre">Square</span></tt> objects. To set the
background of the cells, style-sheet classes are used (defined in <a class="reference external" href="css/sokoban.css">sokoban.css</a>), which are assigned to the <tt class="docutils literal"><span class="pre">td</span></tt> elements&#8217; <tt class="docutils literal"><span class="pre">className</span></tt>
property.</p>
<p>The methods like <tt class="docutils literal"><span class="pre">hasPlayer</span></tt> and <tt class="docutils literal"><span class="pre">isEmpty</span></tt> are a way to &#8216;isolate&#8217; the code
that uses objects of this type from the internals of the objects. They are not
strictly necessary in this case, but they will make the other code look better.</p>
<hr class="docutils" />
<p>The next object type will be called <tt class="docutils literal"><span class="pre">SokobanField</span></tt>. Its constructor is given
an object from the <tt class="docutils literal"><span class="pre">sokobanLevels</span></tt> array, and is responsible for building
both a table of DOM nodes and a grid of <tt class="docutils literal"><span class="pre">Square</span></tt> objects. This object will
also take care of the details of moving the player and boulders around, through
a <tt class="docutils literal"><span class="pre">move</span></tt> method that is given an argument indicating which way the player
wants to move.</p>
<p>To identify the individual squares, and to indicate directions, we will again
use the <tt class="docutils literal"><span class="pre">Point</span></tt> object type from <a class="reference internal" href="ch11.html#oop-chapter"><em>Object-oriented Programming</em></a>, which, as you might
remember, has an <tt class="docutils literal"><span class="pre">add</span></tt> method.</p>
<p>The base of the field prototype looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">SokobanField</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tbody</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;TBODY&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">squares</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">bouldersToGo</span> <span class="o">=</span> <span class="nx">level</span><span class="p">.</span><span class="nx">boulders</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">level</span><span class="p">.</span><span class="nx">field</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">level</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">tableRow</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;TR&quot;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">squareRow</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">tableCell</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;TD&quot;</span><span class="p">);</span>
                <span class="nx">tableRow</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tableCell</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">square</span> <span class="o">=</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">tableCell</span><span class="p">);</span>
                <span class="nx">squareRow</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">square</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">square</span><span class="p">.</span><span class="nx">hasPlayer</span><span class="p">())</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">playerPos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">tbody</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">tableRow</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">squares</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">squareRow</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;TABLE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="o">:</span> <span class="s2">&quot;sokoban&quot;</span><span class="p">},</span> <span class="nx">tbody</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">score</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;DIV&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">updateScore</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">getSquare</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">squares</span><span class="p">[</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">updateScore</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bouldersToGo</span> <span class="o">+</span>
                                            <span class="s2">&quot; boulders to go.&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">won</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bouldersToGo</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">testField</span> <span class="o">=</span> <span class="nx">SokobanField</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">sokobanLevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">testField</span><span class="p">.</span><span class="nx">getSquare</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nx">content</span><span class="p">);</span>
</pre></div>
</div>
<p>The constructor goes over the lines and characters in the level, and stores the
<tt class="docutils literal"><span class="pre">Square</span></tt> objects in the <tt class="docutils literal"><span class="pre">squares</span></tt> property. When it encounters the square
with the player, it saves this position as <tt class="docutils literal"><span class="pre">playerPos</span></tt>, so that we can easily
find the square with the player later on.  <tt class="docutils literal"><span class="pre">getSquare</span></tt> is used to find a
<tt class="docutils literal"><span class="pre">Square</span></tt> object corresponding to a certain <tt class="docutils literal"><span class="pre">x,y</span></tt> position on the field.
Note that it doesn&#8217;t take the edges of the field into account ― to avoid
writing some boring code, we assume that the field is properly walled off,
making it impossible to walk out of it.</p>
<p>The word <tt class="docutils literal"><span class="pre">&quot;class&quot;</span></tt> in the <tt class="docutils literal"><span class="pre">dom</span></tt> call that makes the <tt class="docutils literal"><span class="pre">table</span></tt> node is
quoted as a string. This is necessary because <tt class="docutils literal"><span class="pre">class</span></tt> is a &#8216;reserved word&#8217; in
JavaScript, and may not be used as a variable or property name.</p>
<p>The amount of boulders that have to be cleared to win the level (this may be
less than the total amount of boulders on the level) is stored in
<tt class="docutils literal"><span class="pre">bouldersToGo</span></tt>. Whenever a boulder is brought to the exit, we can subtract 1
from this, and see whether the game is won yet. To show the player how he is
doing, we will have to show this amount somehow. For this purpose, a <tt class="docutils literal"><span class="pre">div</span></tt>
element with text is used. <tt class="docutils literal"><span class="pre">div</span></tt> nodes are containers without inherent
markup. The score text can be updated with the <tt class="docutils literal"><span class="pre">updateScore</span></tt> method. The
<tt class="docutils literal"><span class="pre">won</span></tt> method will be used by the controller object to determine when the game
is over, so the player can move on to the next level.</p>
<hr class="docutils" />
<p>If we want to actually see the playing field and the score, we will have to
insert them into the document somehow. That is what the <tt class="docutils literal"><span class="pre">place</span></tt> method is
for. We&#8217;ll also add a <tt class="docutils literal"><span class="pre">remove</span></tt> method to make it easy to remove a field when
we are done with it.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">SokobanField</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">where</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">where</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">);</span>
    <span class="nx">where</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">SokobanField</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">removeElement</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">);</span>
    <span class="nx">removeElement</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">testField</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</pre></div>
</div>
<p>If all went well, you should see a Sokoban field now.</p>
<hr class="docutils" />
<p>All the &#8220;game logic&#8221; has been taken care of now, and we just need a controller
to make it playable. The controller will be an object type called
<tt class="docutils literal"><span class="pre">SokobanGame</span></tt>, which is responsible for the following things:</p>
<ul class="simple">
<li>Preparing a place where the game field can be placed.</li>
<li>Building and removing <tt class="docutils literal"><span class="pre">SokobanField</span></tt> objects.</li>
<li>Capturing key events and calling the <tt class="docutils literal"><span class="pre">move</span></tt> method on current field with
the correct argument.</li>
<li>Keeping track of the current level number and moving to the next level when
a level is won.</li>
<li>Adding buttons to reset the current level or the whole game
(back to level 0).</li>
</ul>
<p>We start again with an unfinished prototype.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">SokobanGame</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">place</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">field</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">newGame</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;BUTTON&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;New game&quot;</span><span class="p">);</span>
        <span class="nx">addHandler</span><span class="p">(</span><span class="nx">newGame</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">method</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;newGame&quot;</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">reset</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;BUTTON&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;Reset level&quot;</span><span class="p">);</span>
        <span class="nx">addHandler</span><span class="p">(</span><span class="nx">reset</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">method</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;DIV&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                         <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;H1&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;Sokoban&quot;</span><span class="p">),</span>
                         <span class="nx">dom</span><span class="p">(</span><span class="s2">&quot;DIV&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">newGame</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nx">reset</span><span class="p">));</span>
        <span class="nx">place</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">);</span>

        <span class="nx">addHandler</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">method</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;keyDown&quot;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">newGame</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">newGame</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">field</span> <span class="o">=</span> <span class="nx">SokobanField</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">sokobanLevels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">level</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">keyDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// To be filled in</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The constructor builds a <tt class="docutils literal"><span class="pre">div</span></tt> element to hold the field, along with two
buttons and a title. Note how <tt class="docutils literal"><span class="pre">method</span></tt> is used to attach methods on the
<tt class="docutils literal"><span class="pre">this</span></tt> object to events.</p>
<p>We can put a Sokoban game into our document like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">sokoban</span> <span class="o">=</span> <span class="nx">SokobanGame</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Other event types that can be useful are <tt class="docutils literal"><span class="pre">focus</span></tt> and <tt class="docutils literal"><span class="pre">blur</span></tt>, which are
fired on elements that can be &#8216;focused&#8217;, such as form inputs. <tt class="docutils literal"><span class="pre">focus</span></tt>,
obviously, happens when you put the focus on the element, for example by
clicking on it. <tt class="docutils literal"><span class="pre">blur</span></tt> is JavaScript-speak for &#8216;unfocus&#8217;, and is fired when
the focus leaves the element.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">addHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;yellow&quot;</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">addHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Another event related to form inputs is <tt class="docutils literal"><span class="pre">change</span></tt>. This is fired when the
content of the input has changed... except that for some inputs, such as text
inputs, it does not fire until the element is unfocused.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">addHandler</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;textfield&quot;</span><span class="p">),</span> <span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Content of text field changed to &#39;&quot;</span><span class="p">,</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&quot;&#39;.&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You can type all you want, the event will only fire when you click outside of
the input, press tab, or unfocus it in some other way.</p>
<p>Forms also have a <tt class="docutils literal"><span class="pre">submit</span></tt> event, which is fired when they submit. It can be
stopped to prevent the submit from taking place.  This gives us a <em>much</em> better
way to do the form validation we saw in the previous chapter. You just register
a <tt class="docutils literal"><span class="pre">submit</span></tt> handler, which stops the event when the content of the form is not
valid.  That way, when the user does not have JavaScript enabled, the form will
still work, it just won&#8217;t have instant validation.</p>
<p>Window objects have a <tt class="docutils literal"><span class="pre">load</span></tt> event that fires when the document is fully
loaded, which can be useful if your script needs to do some kind of
initialisation that has to wait until the whole document is present. For
example, the scripts on the pages for this book go over the current chapter to
hide solutions to exercises.  You can&#8217;t do that when the exercises are not
loaded yet. There is also an <tt class="docutils literal"><span class="pre">unload</span></tt> event, firing when the user leaves the
document, but this is not properly supported by all browsers.</p>
<p>Most of the time it is best to leave the laying out of a document to the
browser, but there are effects that can only be produced by having a piece of
JavaScript set the exact sizes of some nodes in a document. When you do this,
make sure you also listen for <tt class="docutils literal"><span class="pre">resize</span></tt> events on the window, and re-calculate
the sizes of your element every time the window is resized.</p>
<hr class="docutils" />
<p>Finally, I have to tell you something about event handlers that you would
rather not know. The Internet Explorer browser (which means, at the time of
writing, the browser used by a majority of web-surfers) has a bug that causes
values to not be cleaned up as normal: Even when they are no longer used, they
stay in the machine&#8217;s memory. This is known as a memory leak, and, once enough
memory has been leaked, will seriously slow down a computer.</p>
<p>When does this leaking occur? Due to a deficiency in Internet Explorer&#8217;s
garbage collector, the system whose purpose it is to reclaim unused values,
when you have a DOM node that, through one of its properties or in a more
indirect way, refers to a normal JavaScript object, and this object, in turn,
refers back to that DOM node, both objects will not be collected. This has
something to do with the fact that DOM nodes and other JavaScript objects are
collected by different systems ― the system that cleans up DOM nodes will take
care to leave any nodes that are still referenced by JavaScript objects, and
vice versa for the system that collects normal JavaScript values.</p>
<p>As the above description shows, the problem is not specifically related to
event handlers. This code, for example, creates a bit of un-collectable memory:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">jsObject</span> <span class="o">=</span> <span class="p">{</span><span class="nx">link</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">};</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">linkBack</span> <span class="o">=</span> <span class="nx">jsObject</span><span class="p">;</span>
</pre></div>
</div>
<p>Even after such an Internet Explorer browser goes to a different page, it will
still hold on to the <tt class="docutils literal"><span class="pre">document.body</span></tt> shown here.  The reason this bug is
often associated with event handlers is that it is extremely easy to make such
circular links when registering a handler. The DOM node keeps references to its
handlers, and the handler, most of the time, has a reference to the DOM node.
Even when this reference is not intentionally made, JavaScript&#8217;s scoping rules
tend to add it implicitly. Consider this function:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">addAlerter</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">addHandler</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Alert! ALERT!&quot;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The anonymous function that is created by the <tt class="docutils literal"><span class="pre">addAlerter</span></tt> function can &#8216;see&#8217;
the <tt class="docutils literal"><span class="pre">element</span></tt> variable. It doesn&#8217;t use it, but that does not matter ― just
because it can see it, it will have a reference to it. By registering this
function as an event handler on that same <tt class="docutils literal"><span class="pre">element</span></tt> object, we have created a
circle.</p>
<p>There are three ways to deal with this problem. The first approach, a very
popular one, is to ignore it. Most scripts will only leak a little bit, so it
takes a long time and a lot of pages before the problems become noticeable.
And, when the problems are so subtle, who&#8217;s going to hold <em>you</em> responsible?
Programmers given to this approach will often searingly denounce Microsoft for
their shoddy programming, and state that the problem is not their fault, so
<em>they</em> shouldn&#8217;t be fixing it.</p>
<p>Such reasoning is not entirely without merit, of course. But when half your
users are having problems with the web-pages you make, it is hard to deny that
there is a practical problem. Which is why people working on &#8216;serious&#8217; sites
usually make an attempt not to leak any memory. Which brings us to the second
approach: Painstakingly making sure that no circular references between DOM
objects and regular objects are created. This means, for example, rewriting the
above handler like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">addAlerter</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">addHandler</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Alert! ALERT!&quot;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">element</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now the <tt class="docutils literal"><span class="pre">element</span></tt> variable no longer points at the DOM node, and the handler
will not leak. This approach is viable, but requires the programmer to <em>really</em>
pay attention.</p>
<p>The third solution, finally, is to not worry too much about creating leaky
structures, but to make sure to clean them up when you are done with them. This
means unregistering any event handlers when they are no longer needed, and
registering an <tt class="docutils literal"><span class="pre">onunload</span></tt> event to unregister the handlers that are needed
until the page is unloaded. It is possible to extend an event-registering
system, like our <tt class="docutils literal"><span class="pre">addHandler</span></tt> function, to automatically do this. When
taking this approach, you must keep in mind that event handlers are not the
only possible source of memory leaks ― adding properties to DOM node objects
can cause similar problems.</p>
<div class="section" id="exercises">
<h2>7.1. Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="exercises/ch07/ch07s01.html#ch07s01"><em>Chapter 7 Exercise Set 1</em></a></li>
</ul>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ch08.html" title="8. HTTP requests"
             >next</a> |</li>
        <li class="right" >
          <a href="ch06.html" title="6. The Document-Object Model"
             >previous</a> |</li>
        <li><a href="index.html">A Modern Introduction to Programming with JavaScript and jQuery</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="copyright.html">Copyright</a> 2013, Marijn Haverbeke and Jeffrey Elkner.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>