<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>11. Object-oriented Programming &mdash; A Modern Introduction to Programming with JavaScript and jQuery</title>
    
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1st Edition',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="top" title="A Modern Introduction to Programming with JavaScript and jQuery" href="index.html" />
    <link rel="next" title="12. Modularity" href="ch12.html" />
    <link rel="prev" title="10. Searching" href="ch10.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ch12.html" title="12. Modularity"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ch10.html" title="10. Searching"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">A Modern Introduction to Programming with JavaScript and jQuery</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="object-oriented-programming">
<span id="oop-chapter"></span><h1>11. Object-oriented Programming<a class="headerlink" href="#object-oriented-programming" title="Permalink to this headline">Â¶</a></h1>
<p>In the early nineties, a thing called object-oriented programming stirred up
the software industry. Most of the ideas behind it were not really new at the
time, but they had finally gained enough momentum to start rolling, to become
fashionable. Books were being written, courses given, programming languages
developed. All of a sudden, everybody was extolling the virtues of
object-orientation, enthusiastically applying it to every problem, convincing
themselves they had finally found the <em>right way to write programs</em>.</p>
<p>These things happen a lot. When a process is hard and confusing, people are
always on the lookout for a magic solution. When something looking like such a
solution presents itself, they are prepared to become devoted followers. For
many programmers, even today, object-orientation (or their view of it) is the
gospel. When a program is not &#8216;truly object-oriented&#8217;, whatever that means, it
is considered decidedly inferior.</p>
<p>Few fads have managed to stay popular for as long as this one, though.
Object-orientation&#8217;s longevity can largely be explained by the fact that the
ideas at its core are very solid and useful. In this chapter, we will discuss
these ideas, along with JavaScript&#8217;s (rather eccentric) take on them. The above
paragraphs are by no means meant to discredit these ideas. What I want to do is
warn the reader against developing an unhealthy attachment to them.</p>
<hr class="docutils" />
<p>As the name suggests, object-oriented programming is related to objects. So
far, we have used objects as loose aggregations of values, adding and altering
their properties whenever we saw fit.  In an object-oriented approach, objects
are viewed as little worlds of their own, and the outside world may touch them
only through a limited and well-defined interface, a number of specific methods
and properties. The &#8216;reached list&#8217; we used at the end of
<a class="reference internal" href="ch10.html#searching-chapter"><em>Searching</em></a> is an example of this: We used only three functions,
<tt class="docutils literal"><span class="pre">makeReachedList</span></tt>, <tt class="docutils literal"><span class="pre">storeReached</span></tt>, and <tt class="docutils literal"><span class="pre">findReached</span></tt> to interact with it.
These three functions form an interface for such objects.</p>
<p>The <tt class="docutils literal"><span class="pre">Date</span></tt>, <tt class="docutils literal"><span class="pre">Error</span></tt>, and <tt class="docutils literal"><span class="pre">BinaryHeap</span></tt> objects we have seen also work like
this. Instead of providing regular functions for working with the objects, they
provide a way to create such objects, using the <tt class="docutils literal"><span class="pre">new</span></tt> keyword, and a number
of methods and properties that provide the rest of the interface.</p>
<hr class="docutils" />
<p>One way to give an object methods is to simply attach function values to it.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rabbit</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">rabbit</span><span class="p">.</span><span class="nx">speak</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The rabbit says &#39;&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">rabbit</span><span class="p">.</span><span class="nx">speak</span><span class="p">(</span><span class="s2">&quot;Well, now you&#39;re asking me.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>In most cases, the method will need to know <em>who</em> it should act on.  For
example, if there are different rabbits, the <tt class="docutils literal"><span class="pre">speak</span></tt> method must indicate
which rabbit is speaking. For this purpose, there is a special variable called
<tt class="docutils literal"><span class="pre">this</span></tt>, which is always present when a function is called, and which points
at the relevant object when the function is called as a method. A function is
called as a method when it is looked up as a property, and immediately called,
as in <tt class="docutils literal"><span class="pre">object.method()</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">speak</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span><span class="p">,</span> <span class="s2">&quot; rabbit says &#39;&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">whiteRabbit</span> <span class="o">=</span> <span class="p">{</span><span class="nx">adjective</span><span class="o">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="nx">speak</span><span class="o">:</span> <span class="nx">speak</span><span class="p">};</span>
<span class="kd">var</span> <span class="nx">fatRabbit</span> <span class="o">=</span> <span class="p">{</span><span class="nx">adjective</span><span class="o">:</span> <span class="s2">&quot;fat&quot;</span><span class="p">,</span> <span class="nx">speak</span><span class="o">:</span> <span class="nx">speak</span><span class="p">};</span>

<span class="nx">whiteRabbit</span><span class="p">.</span><span class="nx">speak</span><span class="p">(</span><span class="s2">&quot;Oh my ears and whiskers, how late it&#39;s getting!&quot;</span><span class="p">);</span>
<span class="nx">fatRabbit</span><span class="p">.</span><span class="nx">speak</span><span class="p">(</span><span class="s2">&quot;I could sure use a carrot right now.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>I can now clarify the mysterious first argument to the <tt class="docutils literal"><span class="pre">apply</span></tt> method, for
which we always used <tt class="docutils literal"><span class="pre">null</span></tt> in <a class="reference internal" href="ch09.html#functional-programming-chapter"><em>Functional Programming</em></a>. This
argument can be used to specify the object that the function must be applied
to. For non-method functions, this is irrelevant, hence the <tt class="docutils literal"><span class="pre">null</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">speak</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">fatRabbit</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Yum.&quot;</span><span class="p">]);</span>
</pre></div>
</div>
<p>Functions also have a <tt class="docutils literal"><span class="pre">call</span></tt> method, which is similar to <tt class="docutils literal"><span class="pre">apply</span></tt>, but you
can give the arguments for the function separately instead of as an array:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">speak</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">fatRabbit</span><span class="p">,</span> <span class="s2">&quot;Burp.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>The <tt class="docutils literal"><span class="pre">new</span></tt> keyword provides a convenient way of creating new objects. When a
function is called with the word <tt class="docutils literal"><span class="pre">new</span></tt> in front of it, its <tt class="docutils literal"><span class="pre">this</span></tt> variable
will point at a <em>new</em> object, which it will automatically return (unless it
explicitly returns something else). Functions used to create new objects like
this are called constructors. Here is a constructor for rabbits:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Rabbit</span><span class="p">(</span><span class="nx">adjective</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span> <span class="o">=</span> <span class="nx">adjective</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">speak</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span><span class="p">,</span> <span class="s2">&quot; rabbit says &#39;&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">killerRabbit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Rabbit</span><span class="p">(</span><span class="s2">&quot;killer&quot;</span><span class="p">);</span>
<span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">speak</span><span class="p">(</span><span class="s2">&quot;GRAAAAAAAAAH!&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>It is a convention, among JavaScript programmers, to start the names of
constructors with a capital letter. This makes it easy to distinguish them from
other functions.</p>
<p>Why is the <tt class="docutils literal"><span class="pre">new</span></tt> keyword even necessary? After all, we could have simply
written this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">makeRabbit</span><span class="p">(</span><span class="nx">adjective</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">adjective</span><span class="o">:</span> <span class="nx">adjective</span><span class="p">,</span>
        <span class="nx">speak</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*etc*/</span><span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">blackRabbit</span> <span class="o">=</span> <span class="nx">makeRabbit</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>But that is not entirely the same. <tt class="docutils literal"><span class="pre">new</span></tt> does a few things behind the scenes.
For one thing, our <tt class="docutils literal"><span class="pre">killerRabbit</span></tt> has a property called <tt class="docutils literal"><span class="pre">constructor</span></tt>,
which points at the <tt class="docutils literal"><span class="pre">Rabbit</span></tt> function that created it. <tt class="docutils literal"><span class="pre">blackRabbit</span></tt> also
has such a property, but it points at the <tt class="docutils literal"><span class="pre">Object</span></tt> function.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">show</span><span class="p">(</span><span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span>
<span class="nx">show</span><span class="p">(</span><span class="nx">blackRabbit</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Where did the <tt class="docutils literal"><span class="pre">constructor</span></tt> property come from? It is part of the prototype
of a rabbit. Prototypes are a powerful, if somewhat confusing, part of the way
JavaScript objects work. Every object is based on a prototype, which gives it a
set of inherent properties.  The simple objects we have used so far are based
on the most basic prototype, which is associated with the <tt class="docutils literal"><span class="pre">Object</span></tt>
constructor. In fact, typing <tt class="docutils literal"><span class="pre">{}</span></tt> is equivalent to typing <tt class="docutils literal"><span class="pre">new</span> <span class="pre">Object()</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">simpleObject</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">simpleObject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">simpleObject</span><span class="p">.</span><span class="nx">toString</span><span class="p">);</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">toString</span></tt> is a method that is part of the <tt class="docutils literal"><span class="pre">Object</span></tt> prototype.  This means
that all simple objects have a <tt class="docutils literal"><span class="pre">toString</span></tt> method, which converts them to a
string. Our rabbit objects are based on the prototype associated with the
<tt class="docutils literal"><span class="pre">Rabbit</span></tt> constructor. You can use a constructor&#8217;s <tt class="docutils literal"><span class="pre">prototype</span></tt> property to
get access to, well, their prototype:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">alert</span><span class="p">(</span><span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span>
</pre></div>
</div>
<p>Every function automatically gets a <tt class="docutils literal"><span class="pre">prototype</span></tt> property, whose
<tt class="docutils literal"><span class="pre">constructor</span></tt> property points back at the function. Because the rabbit
prototype is itself an object, it is based on the <tt class="docutils literal"><span class="pre">Object</span></tt> prototype, and
shares its <tt class="docutils literal"><span class="pre">toString</span></tt> method.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">alert</span><span class="p">(</span><span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">toString</span> <span class="o">==</span> <span class="nx">simpleObject</span><span class="p">.</span><span class="nx">toString</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Even though objects seem to share the properties of their prototype, this
sharing is one-way. The properties of the prototype influence the object based
on it, but the properties of this object never change the prototype.</p>
<p>The precise rules are this: When looking up the value of a property, JavaScript
first looks at the properties that the object <em>itself</em> has. If there is a
property that has the name we are looking for, that is the value we get. If
there is no such property, it continues searching the prototype of the object,
and then the prototype of the prototype, and so on. If no property is found,
the value <tt class="docutils literal"><span class="pre">undefined</span></tt> is given. On the other hand, when <em>setting</em> the value
of a property, JavaScript never goes to the prototype, but always sets the
property in the object itself.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">teeth</span> <span class="o">=</span> <span class="s2">&quot;small&quot;</span><span class="p">;</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">teeth</span><span class="p">);</span>
<span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">teeth</span> <span class="o">=</span> <span class="s2">&quot;long, sharp, and bloody&quot;</span><span class="p">;</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">teeth</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">teeth</span><span class="p">);</span>
</pre></div>
</div>
<p>This does mean that the prototype can be be used at any time to add new
properties and methods to all objects based on it. For example, it might become
necessary for our rabbits to dance.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span><span class="p">,</span> <span class="s2">&quot; rabbit dances a jig.&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">killerRabbit</span><span class="p">.</span><span class="nx">dance</span><span class="p">();</span>
</pre></div>
</div>
<p>And, as you might have guessed, the prototypical rabbit is the perfect place
for values that all rabbits have in common, such as the <tt class="docutils literal"><span class="pre">speak</span></tt> method. Here
is a new approach to the <tt class="docutils literal"><span class="pre">Rabbit</span></tt> constructor:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Rabbit</span><span class="p">(</span><span class="nx">adjective</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span> <span class="o">=</span> <span class="nx">adjective</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Rabbit</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">speak</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjective</span><span class="p">,</span> <span class="s2">&quot; rabbit says &#39;&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">hazelRabbit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Rabbit</span><span class="p">(</span><span class="s2">&quot;hazel&quot;</span><span class="p">);</span>
<span class="nx">hazelRabbit</span><span class="p">.</span><span class="nx">speak</span><span class="p">(</span><span class="s2">&quot;Good Frith!&quot;</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>The fact that all objects have a prototype and receive some properties from
this prototype can be tricky. It means that using an object to store a set of
things, such as the cats from <a class="reference internal" href="ch03.html#objects-and-arrays-chapter"><em>Data structures: Objects and Arrays</em></a>, can go wrong.
If, for example, we wondered whether there is a cat called <tt class="docutils literal"><span class="pre">&quot;constructor&quot;</span></tt>,
we would have checked it like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">noCatsAtAll</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">if</span> <span class="p">(</span><span class="s2">&quot;constructor&quot;</span> <span class="k">in</span> <span class="nx">noCatsAtAll</span><span class="p">)</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Yes, there definitely is a cat called &#39;constructor&#39;.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This is problematic. A related problem is that it can often be practical to
extend the prototypes of standard constructors such as <tt class="docutils literal"><span class="pre">Object</span></tt> and <tt class="docutils literal"><span class="pre">Array</span></tt>
with new useful functions. For example, we could give all objects a method
called <tt class="docutils literal"><span class="pre">properties</span></tt>, which returns an array with the names of the
(non-hidden) properties that the object has:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">properties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">3</span><span class="p">};</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">properties</span><span class="p">());</span>
</pre></div>
</div>
<p>And that immediately shows the problem. Now that the <tt class="docutils literal"><span class="pre">Object</span></tt> prototype has a
property called <tt class="docutils literal"><span class="pre">properties</span></tt>, looping over the properties of any object,
using <tt class="docutils literal"><span class="pre">for</span></tt> and <tt class="docutils literal"><span class="pre">in</span></tt>, will also give us that shared property, which is
generally not what we want. We are interested only in the properties that the
object itself has.</p>
<p>Fortunately, there is a way to find out whether a property belongs to the
object itself or to one of its prototypes. Unfortunately, it does make looping
over the properties of an object a bit clumsier.  Every object has a method
called <tt class="docutils literal"><span class="pre">hasOwnProperty</span></tt>, which tells us whether the object has a property
with a given name. Using this, we could rewrite our <tt class="docutils literal"><span class="pre">properties</span></tt> method like
this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">properties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Fat Igor&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;Fireball&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">properties</span><span class="p">());</span>
</pre></div>
</div>
<p>And of course, we can abstract that into a higher-order function.  Note that
the <tt class="docutils literal"><span class="pre">action</span></tt> function is called with both the name of the property and the
value it has in the object.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">forEachIn</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span>
            <span class="nx">action</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">chimera</span> <span class="o">=</span> <span class="p">{</span><span class="nx">head</span><span class="o">:</span> <span class="s2">&quot;lion&quot;</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s2">&quot;goat&quot;</span><span class="p">,</span> <span class="nx">tail</span><span class="o">:</span> <span class="s2">&quot;snake&quot;</span><span class="p">};</span>
<span class="nx">forEachIn</span><span class="p">(</span><span class="nx">chimera</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;The &quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; of a &quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>But, what if we find a cat named <tt class="docutils literal"><span class="pre">hasOwnProperty</span></tt>? (You never know.) It will
be stored in the object, and the next time we want to go over the collection of
cats, calling <tt class="docutils literal"><span class="pre">object.hasOwnProperty</span></tt> will fail, because that property no
longer points at a function value. This can be solved by doing something even
uglier:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">forEachIn</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">))</span>
            <span class="nx">action</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Mordecai&quot;</span><span class="p">,</span> <span class="nx">hasOwnProperty</span><span class="o">:</span> <span class="s2">&quot;Uh-oh&quot;</span><span class="p">};</span>
<span class="nx">forEachIn</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Property &quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; = &quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example does not currently work correctly in Internet Explorer 8,
which apparently has some problems with overriding built-in prototype
properties.</p>
</div>
<p>Here, instead of using the method found in the object itself, we get the method
from the <tt class="docutils literal"><span class="pre">Object</span></tt> prototype, and then use <tt class="docutils literal"><span class="pre">call</span></tt> to apply it to the right
object. Unless someone actually messes with the method in <tt class="docutils literal"><span class="pre">Object.prototype</span></tt>
(don&#8217;t do that), this should work correctly.</p>
<hr class="docutils" />
<p><tt class="docutils literal"><span class="pre">hasOwnProperty</span></tt> can also be used in those situations where we have been
using the <tt class="docutils literal"><span class="pre">in</span></tt> operator to see whether an object has a specific property.
There is one more catch, however. We saw in <a class="reference internal" href="ch03.html#objects-and-arrays-chapter"><em>Data structures: Objects and Arrays</em></a>
that some properties, such as <tt class="docutils literal"><span class="pre">toString</span></tt>, are &#8216;hidden&#8217;, and do not show up
when going over properties with <tt class="docutils literal"><span class="pre">for</span></tt>/<tt class="docutils literal"><span class="pre">in</span></tt>. It turns out that browsers in
the Gecko family (Firefox, most importantly) give every object a hidden
property named <tt class="docutils literal"><span class="pre">__proto__</span></tt>, which points to the prototype of that object.
<tt class="docutils literal"><span class="pre">hasOwnProperty</span></tt> will return <tt class="docutils literal"><span class="pre">true</span></tt> for this one, even though the program
did not explicitly add it. Having access to the prototype of an object can be
very convenient, but making it a property like that was not a very good idea.
Still, Firefox is a widely used browser, so when you write a program for the
web you have to be careful with this. There is a method
<tt class="docutils literal"><span class="pre">propertyIsEnumerable</span></tt>, which returns <tt class="docutils literal"><span class="pre">false</span></tt> for hidden properties, and
which can be used to filter out strange things like <tt class="docutils literal"><span class="pre">__proto__</span></tt>. An
expression such as this one can be used to reliably work around this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{</span><span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">};</span>
<span class="nx">alert</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Nice and simple, no? This is one of the not-so-well-designed aspects of
JavaScript. Objects play both the role of &#8220;values with methods&#8221;, for which
prototypes work great, and &#8216;sets of properties&#8217;, for which prototypes only get
in the way.</p>
<hr class="docutils" />
<p>Writing the above expression every time you need to check whether a property is
present in an object is unworkable. We could put it into a function, but an
even better approach is to write a constructor and a prototype specifically for
situations like this, where we want to approach an object as just a set of
properties.  Because you can use it to look things up by name, we will call it
a <tt class="docutils literal"><span class="pre">Dictionary</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Dictionary</span><span class="p">(</span><span class="nx">startValues</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="nx">startValues</span> <span class="o">||</span> <span class="p">{};</span>
<span class="p">}</span>
<span class="nx">Dictionary</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Dictionary</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lookup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
<span class="p">};</span>
<span class="nx">Dictionary</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">Dictionary</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">forEachIn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">,</span> <span class="nx">action</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dictionary</span><span class="p">({</span><span class="nx">Grover</span><span class="o">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                             <span class="nx">Elmo</span><span class="o">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                             <span class="nx">Bert</span><span class="o">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">});</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">colors</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s2">&quot;Grover&quot;</span><span class="p">));</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">colous</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s2">&quot;constructor&quot;</span><span class="p">));</span>
<span class="nx">colors</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; is &quot;</span><span class="p">,</span> <span class="nx">color</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Now the whole mess related to approaching objects as plain sets of properties
has been &#8220;encapsulated&#8221; in a convenient interface: one constructor and four
methods. Note that the <tt class="docutils literal"><span class="pre">values</span></tt> property of a <tt class="docutils literal"><span class="pre">Dictionary</span></tt> object is not
part of this interface, it is an internal detail, and when you are using
<tt class="docutils literal"><span class="pre">Dictionary</span></tt> objects you do not need to directly use it.</p>
<p>Whenever you write an interface, it is a good idea to add a comment with a
quick sketch of what it does and how it should be used. This way, when someone,
possibly yourself three months after you wrote it, wants to work with the
interface, they can quickly see how to use it, and do not have to study the
whole program.</p>
<p>Most of the time, when you are designing an interface, you will soon find some
limitations and problems in whatever you came up with, and change it. To
prevent wasting your time, it is advisable to document your interfaces only
<em>after</em> they have been used in a few real situations and proven themselves to
be practical. â Of course, this might make it tempting to forget about
documentation altogether. Personally, I treat writing documentation as a
&#8220;finishing touch&#8221; to add to a system. When it feels ready, it is time to write
something about it, and to see if it sounds as good in English (or whatever
language) as it does in JavaScript (or whatever programming language).</p>
<hr class="docutils" />
<p>The distinction between the external interface of an object and its internal
details is important for two reasons. Firstly, having a small, clearly
described interface makes an object easier to use.  You only have to keep the
interface in mind, and do not have to worry about the rest unless you are
changing the object itself.</p>
<p>Secondly, it often turns out to be necessary or practical to change something
about the internal implementation of an object type (such types are usually
called &#8220;classes&#8221; in other programming languages), to make it more efficient,
for example, or to fix some problem. When outside code is accessing every
single property and detail in the object, you can not change any of them
without also updating a lot of other code. If outside code only uses a small
interface, you can do what you want, as long as you do not change the
interface.</p>
<p>Some people go very far in this. They will, for example, never include
properties in the interface of object, only methods â if their object type has
a length, it will be accessible with the <tt class="docutils literal"><span class="pre">getLength</span></tt> method, not the
<tt class="docutils literal"><span class="pre">length</span></tt> property. This way, if they ever want to change their object in such
a way that it no longer has a <tt class="docutils literal"><span class="pre">length</span></tt> property, for example because it now
has some internal array whose length it must return, they can update the
function without changing the interface.</p>
<p>My own take is that in most cases this is not worth it. Adding a <tt class="docutils literal"><span class="pre">getLength</span></tt>
method which only contains <tt class="docutils literal"><span class="pre">return</span> <span class="pre">this.length;</span></tt> mostly just adds meaningless
code, and, in most situations, I consider meaningless code a bigger problem
than the risk of having to occasionally change the interface to my objects.</p>
<hr class="docutils" />
<p>Adding new methods to existing prototypes can be very convenient.  Especially
the <tt class="docutils literal"><span class="pre">Array</span></tt> and <tt class="docutils literal"><span class="pre">String</span></tt> prototypes in JavaScript could use a few more
basic methods. We could, for example, replace <tt class="docutils literal"><span class="pre">forEach</span></tt> and <tt class="docutils literal"><span class="pre">map</span></tt> with
methods on arrays, and make the <tt class="docutils literal"><span class="pre">startsWith</span></tt> function we wrote in
<a class="reference internal" href="ch03.html#objects-and-arrays-chapter"><em>Data structures: Objects and Arrays</em></a> a method on strings.</p>
<p>However, if your program has to run on the same web-page as another program
(either written by you or by someone else) which uses <tt class="docutils literal"><span class="pre">for</span></tt>/<tt class="docutils literal"><span class="pre">in</span></tt> naively â
the way we have been using it so far â then adding things to prototypes,
especially the <tt class="docutils literal"><span class="pre">Object</span></tt> and <tt class="docutils literal"><span class="pre">Array</span></tt> prototype, will definitely break
something, because these loops will suddenly start seeing those new properties.
For this reason, some people prefer not to touch these prototypes at all. Of
course, if you are careful, and you do not expect your code to have to coexist
with badly-written code, adding methods to standard prototypes is a perfectly
good technique.</p>
<hr class="docutils" />
<p>In this chapter we are going to build a virtual terrarium, a tank with insects
moving around in it. There will be some objects involved (this is, after all,
the chapter on object-oriented programming). We will take a rather simple
approach, and make the terrarium a two-dimensional grid, like the second map in
<a class="reference internal" href="ch10.html#searching-chapter"><em>Searching</em></a>. On this grid there are a number of bugs. When the
terrarium is active, all the bugs get a chance to take an action, such as
moving, every half second.</p>
<p>Thus, we chop both time and space into units with a fixed size â squares for
space, half seconds for time. This usually makes things easier to model in a
program, but of course has the drawback of being wildly inaccurate.
Fortunately, this terrarium-simulator is not required to be accurate in any
way, so we can get away with it.</p>
<hr class="docutils" />
<p>A terrarium can be defined with a &#8216;plan&#8217;, which is an array of strings. We
could have used a single string, but because JavaScript strings must stay on a
single line it would have been a lot harder to type.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">thePlan</span> <span class="o">=</span>
    <span class="p">[</span><span class="s2">&quot;############################&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#      #    #      o      ##&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                          #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#          #####           #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;##         #   #    ##     #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;###           ##     #     #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#           ###      #     #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#   ####                   #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#   ##       o             #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;# o  #         o       ### #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#    #                     #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;############################&quot;</span><span class="p">];</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">&quot;#&quot;</span></tt> characters are used to represent the walls of the terrarium (and
the ornamental rocks lying in it), the <tt class="docutils literal"><span class="pre">&quot;o&quot;</span></tt>s represent bugs, and the spaces
are, as you might have guessed, empty space.</p>
<p>Such a plan-array can be used to create a terrarium-object. This object keeps
track of the shape and content of the terrarium, and lets the bugs inside move.
It has four methods: Firstly <tt class="docutils literal"><span class="pre">toString</span></tt>, which converts the terrarium back to
a string similar to the plan it was based on, so that you can see what is going
on inside it. Then there is <tt class="docutils literal"><span class="pre">step</span></tt>, which allows all the bugs in the
terrarium to move one step, if they so desire. And finally, there are <tt class="docutils literal"><span class="pre">start</span></tt>
and <tt class="docutils literal"><span class="pre">stop</span></tt>, which control whether the terrarium is &#8216;running&#8217;. When it is
running, <tt class="docutils literal"><span class="pre">step</span></tt> is automatically called every half second, so the bugs keep
moving.</p>
<hr class="docutils" />
<p>When writing objects to implement a certain program, it is not always very
clear which functionality goes where. Some things are best written as methods
of your objects, other things are better expressed as separate functions, and
some things are best implemented by adding a new type of object. To keep things
clear and organised, it is important to keep the amount of methods and
responsibilities that an object type has as small as possible. When an object
does too much, it becomes a big mess of functionality, and a formidable source
of confusion.</p>
<p>I said above that the terrarium object will be responsible for storing its
contents and for letting the bugs inside it move.  Firstly, note that it <em>lets</em>
them move, it doesn&#8217;t <em>make</em> them move. The bugs themselves will also be
objects, and these objects are responsible for deciding what they want to do.
The terrarium merely provides the infrastructure that asks them what to do
every half second, and if they decide to move, it makes sure this happens.</p>
<p>Storing the grid on which the content of the terrarium is kept can get quite
complex. It has to define some kind of representation, ways to access this
representation, a way to initialise the grid from a &#8216;plan&#8217; array, a way to
write the content of the grid to a string for the <tt class="docutils literal"><span class="pre">toString</span></tt> method, and the
movement of the bugs on the grid. It would be nice if part of this could be
moved into another object, so that the terrarium object itself doesn&#8217;t get too
big and complex.</p>
<hr class="docutils" />
<p>Whenever you find yourself about to mix data representation and
problem-specific code in one object, it is a good idea to try and put the data
representation code into a separate type of object. In this case, we need to
represent a grid of values, so I wrote a <tt class="docutils literal"><span class="pre">Grid</span></tt> type, which supports the
operations that the terrarium will need.</p>
<p>To store the values on the grid, there are two options. One can use an array of
arrays, like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;0,0&quot;</span><span class="p">,</span> <span class="s2">&quot;1,0&quot;</span><span class="p">,</span> <span class="s2">&quot;2,0&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;0,1&quot;</span><span class="p">,</span> <span class="s2">&quot;1,1&quot;</span><span class="p">,</span> <span class="s2">&quot;2,1&quot;</span><span class="p">]];</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
</pre></div>
</div>
<p>Or the values can all be put into a single array. In this case, the element at
<tt class="docutils literal"><span class="pre">x</span></tt>,``y`` can be found by getting the element at position <tt class="docutils literal"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">y</span> <span class="pre">*</span> <span class="pre">width</span></tt>
in the array, where <tt class="docutils literal"><span class="pre">width</span></tt> is the width of the grid.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">grid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0,0&quot;</span><span class="p">,</span> <span class="s2">&quot;1,0&quot;</span><span class="p">,</span> <span class="s2">&quot;2,0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0,1&quot;</span><span class="p">,</span> <span class="s2">&quot;1,1&quot;</span><span class="p">,</span> <span class="s2">&quot;2,1&quot;</span><span class="p">];</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">grid</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>I chose the second representation, because it makes it much easier to
initialise the array. <tt class="docutils literal"><span class="pre">new</span> <span class="pre">Array(x)</span></tt> produces a new array of length <tt class="docutils literal"><span class="pre">x</span></tt>,
filled with <tt class="docutils literal"><span class="pre">undefined</span></tt> values.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cells</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">height</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Grid</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">valueAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cells</span><span class="p">[</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">];</span>
<span class="p">};</span>
<span class="nx">Grid</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setValueAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cells</span><span class="p">[</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Grid</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isInside</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
           <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Grid</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">moveValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">valueAt</span><span class="p">(</span><span class="nx">from</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Finally, to test the grid:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">testGrid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Grid</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">testGrid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;#&quot;</span><span class="p">);</span>
<span class="nx">testGrid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;o&quot;</span><span class="p">);</span>
<span class="nx">testGrid</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Before we can start to write a <tt class="docutils literal"><span class="pre">Terrarium</span></tt> constructor, we will have to get a
bit more specific about these &#8216;bug objects&#8217; that will be living inside it.
Earlier, I mentioned that the terrarium will ask the bugs what action they want
to take. This will work as follows: Each bug object has an <tt class="docutils literal"><span class="pre">act</span></tt> method
which, when called, returns an &#8216;action&#8217;. An action is an object with a <tt class="docutils literal"><span class="pre">type</span></tt>
property, which names the type of action the bug wants to take, for example
<tt class="docutils literal"><span class="pre">&quot;move&quot;</span></tt>. For most actions, the action also contains extra information, such
as the direction the bug wants to go.</p>
<p>Bugs are terribly myopic, they can only see the squares directly around them on
the grid. But these they can use to base their action on. When the <tt class="docutils literal"><span class="pre">act</span></tt>
method is called, it is given an object with information about the surroundings
of the bug in question. For each of the eight directions, it contains a
property. The property indicating what is above the bug is called <tt class="docutils literal"><span class="pre">&quot;n&quot;</span></tt>, for
North, the one indicating what is above and to the left <tt class="docutils literal"><span class="pre">&quot;ne&quot;</span></tt>, for
North-East, and so on. To look up the direction these names refer to, the
following dictionary object is useful:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">directions</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dictionary</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;n&quot;</span><span class="o">:</span>  <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
     <span class="s2">&quot;ne&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
     <span class="s2">&quot;e&quot;</span><span class="o">:</span>  <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
     <span class="s2">&quot;se&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span>
     <span class="s2">&quot;s&quot;</span><span class="o">:</span>  <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span>
     <span class="s2">&quot;sw&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span>
     <span class="s2">&quot;w&quot;</span><span class="o">:</span>  <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
     <span class="s2">&quot;nw&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)});</span>

<span class="nx">alert</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">directions</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s2">&quot;se&quot;</span><span class="p">)));</span>
</pre></div>
</div>
<p>When a bug decides to move, he indicates in which direction he wants to go by
giving the resulting action object a <tt class="docutils literal"><span class="pre">direction</span></tt> property that names one of
these directions. We can make a simple, stupid bug that always just goes south,
&#8220;towards the light&#8221;, like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">StupidBug</span><span class="p">()</span> <span class="p">{};</span>
<span class="nx">StupidBug</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">act</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="s2">&quot;s&quot;</span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Now we can start on the <tt class="docutils literal"><span class="pre">Terrarium</span></tt> object type itself. First, its
constructor, which takes a plan (an array of strings) as argument, and
initialises its grid.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">wall</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">function</span> <span class="nx">Terrarium</span><span class="p">(</span><span class="nx">plan</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">grid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">plan</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">plan</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">plan</span><span class="p">[</span><span class="nx">y</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">grid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">),</span>
                            <span class="nx">elementFromCharacter</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">x</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span> <span class="o">=</span> <span class="nx">grid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">elementFromCharacter</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">wall</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">StupidBug</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">wall</span></tt> is an object that is used to mark the location of walls on the grid.
Like a real wall, it doesn&#8217;t do much, it just sits there and takes up space.</p>
<hr class="docutils" />
<p>The most straightforward method of a terrarium object is <tt class="docutils literal"><span class="pre">toString</span></tt>, which
transforms a terrarium into a string. To make this easier, we mark both the
<tt class="docutils literal"><span class="pre">wall</span></tt> and the prototype of the <tt class="docutils literal"><span class="pre">StupidBug</span></tt> with a property <tt class="docutils literal"><span class="pre">character</span></tt>,
which holds the character that represents them.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">wall</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="p">;</span>
<span class="nx">StupidBug</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">characterFromElement</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="nx">element</span><span class="p">.</span><span class="nx">character</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">alert</span><span class="p">(</span><span class="nx">characterFromElement</span><span class="p">(</span><span class="nx">wall</span><span class="p">));</span>
</pre></div>
</div>
<hr class="docutils" />
<p>It is possible that, when trying to solve exercise 7.3, you have tried to
access <tt class="docutils literal"><span class="pre">this.grid</span></tt> inside the function that you pass as an argument to the
grid&#8217;s <tt class="docutils literal"><span class="pre">each</span></tt> method. This will not work. Calling a function always results
in a new <tt class="docutils literal"><span class="pre">this</span></tt> being defined inside that function, even when it is not used
as a method.  Thus, any <tt class="docutils literal"><span class="pre">this</span></tt> variable outside of the function will not be
visible.</p>
<p>Sometimes it is straightforward to work around this by storing the information
you need in a variable, like <tt class="docutils literal"><span class="pre">endOfLine</span></tt>, which <em>is</em> visible in the inner
function. If you need access to the whole <tt class="docutils literal"><span class="pre">this</span></tt> object, you can store that
in a variable too. The name <tt class="docutils literal"><span class="pre">self</span></tt> (or <tt class="docutils literal"><span class="pre">that</span></tt>) is often used for such a
variable.</p>
<p>But all these extra variables can get messy. Another good solution is to use a
function similar to <tt class="docutils literal"><span class="pre">partial</span></tt> from <a class="reference internal" href="ch09.html#functional-programming-chapter"><em>Functional Programming</em></a>.
Instead of adding arguments to a function, this one adds a <tt class="docutils literal"><span class="pre">this</span></tt> object,
using the first argument to the function&#8217;s <tt class="docutils literal"><span class="pre">apply</span></tt> method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">testArray</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">pushTest</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">testArray</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span> <span class="nx">testArray</span><span class="p">);</span>
<span class="nx">pushTest</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">);</span>
<span class="nx">pushTest</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">testArray</span><span class="p">);</span>
</pre></div>
</div>
<p>This way, you can <tt class="docutils literal"><span class="pre">bind</span></tt> an inner function to <tt class="docutils literal"><span class="pre">this</span></tt>, and it will have the
same <tt class="docutils literal"><span class="pre">this</span></tt> as the outer function.</p>
<hr class="docutils" />
<p>We will need <tt class="docutils literal"><span class="pre">bind</span></tt> (or <tt class="docutils literal"><span class="pre">method</span></tt>) when implementing the <tt class="docutils literal"><span class="pre">step</span></tt> method of
a terrarium. This method has to go over all the bugs on the grid, ask them for
an action, and execute the given action. You might be tempted to use <tt class="docutils literal"><span class="pre">each</span></tt>
on the grid, and just handle the bugs we come across. But then, when a bug
moves South or East, we will come across it again in the same turn, and allow
it to move again.</p>
<p>Instead, we first gather all the bugs into an array, and then process them.
This method gathers bugs, or other things that have an <tt class="docutils literal"><span class="pre">act</span></tt> method, and
stores them in objects that also contain their current position:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listActingCreatures</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">act</span><span class="p">)</span>
            <span class="nx">found</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">object</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">point</span><span class="o">:</span> <span class="nx">point</span><span class="p">});</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Both above methods are not part of the external interface of a <tt class="docutils literal"><span class="pre">Terrarium</span></tt>
object, they are internal details. Some languages provide ways to explicitly
declare certain methods and properties &#8220;private&#8221;, and make it an error to use
them from outside the object. JavaScript does not, so you will have to rely on
comments to describe the interface to an object. Sometimes it can be useful to
use some kind of naming scheme to distinguish between external and internal
properties, for example by prefixing all internal ones with an underscore
(&#8216;<tt class="docutils literal"><span class="pre">_</span></tt>&#8216;). This will make accidental uses of properties that are not part of an
object&#8217;s interface easier to spot.</p>
<hr class="docutils" />
<p>Next is one more internal method, the one that will ask a bug for an action and
carry it out. It takes an object with <tt class="docutils literal"><span class="pre">object</span></tt> and <tt class="docutils literal"><span class="pre">point</span></tt> properties, as
returned by <tt class="docutils literal"><span class="pre">listActingCreatures</span></tt>, as argument. For now, it only knows about
the <tt class="docutils literal"><span class="pre">&quot;move&quot;</span></tt> action:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processCreature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">creature</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">surroundings</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">listSurroundings</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">act</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">directions</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">direction</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">directions</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">direction</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">isInside</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">valueAt</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">moveValue</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unsupported action: &quot;</span> <span class="o">+</span> <span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Note that it checks whether the chosen direction is inside of the grid and
empty, and ignores it otherwise. This way, the bugs can ask for any action they
like â the action will only be carried out if it is actually possible. This
acts as a layer of insulation between the bugs and the terrarium, and allows us
to be less precise when writing the bugs&#8217; <tt class="docutils literal"><span class="pre">act</span></tt> methods â for example the
<tt class="docutils literal"><span class="pre">StupidBug</span></tt> just always travels South, regardless of any walls that might
stand in its way.</p>
<hr class="docutils" />
<p>These three internal methods then finally allow us to write the <tt class="docutils literal"><span class="pre">step</span></tt>
method, which gives all bugs a chance to do something (all elements with an
<tt class="docutils literal"><span class="pre">act</span></tt> method â we could also give the <tt class="docutils literal"><span class="pre">wall</span></tt> object one if we so desired,
and make the walls walk).</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">forEach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">listActingCreatures</span><span class="p">(),</span>
            <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">processCreature</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now, let us make a terrarium and see whether the bugs move...</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">terrarium</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Terrarium</span><span class="p">(</span><span class="nx">thePlan</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">terrarium</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">step</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">terrarium</span><span class="p">);</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Wait, how come the above calls <tt class="docutils literal"><span class="pre">alert(terrarium)</span></tt> and ends up displaying the
output of our <tt class="docutils literal"><span class="pre">toString</span></tt> method? <tt class="docutils literal"><span class="pre">alert</span></tt> turns its arguments to strings
using the <tt class="docutils literal"><span class="pre">String</span></tt> function. Objects are turned to strings by calling their
<tt class="docutils literal"><span class="pre">toString</span></tt> method, so giving your own object types a meaningful <tt class="docutils literal"><span class="pre">toString</span></tt>
is a good way to make them readable when printed out.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">alert</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
<hr class="docutils" />
<p>As promised, <tt class="docutils literal"><span class="pre">Terrarium</span></tt> objects also get <tt class="docutils literal"><span class="pre">start</span></tt> and <tt class="docutils literal"><span class="pre">stop</span></tt> methods to
start or stop their simulation. For this, we will use two functions provided by
the browser, called <tt class="docutils literal"><span class="pre">setInterval</span></tt> and <tt class="docutils literal"><span class="pre">clearInterval</span></tt>. The first is used to
cause its first argument (a function, or a string containing JavaScript code)
to be executed periodically. Its second argument gives the amount of
milliseconds (1/1000 second) between invocations. It returns a value that can
be given to <tt class="docutils literal"><span class="pre">clearInterval</span></tt> to stop its effect.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">annoy</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;What?&quot;</span><span class="p">);},</span> <span class="mi">400</span><span class="p">);</span>
</pre></div>
</div>
<p>And...</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">annoy</span><span class="p">);</span>
</pre></div>
</div>
<p>There are similar functions for one-shot time-based actions.  <tt class="docutils literal"><span class="pre">setTimeout</span></tt>
causes a function or string to be executed after a given amount of
milliseconds, and <tt class="docutils literal"><span class="pre">clearTimeout</span></tt> cancels such an action.</p>
<hr class="docutils" />
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">step</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Now we have a terrarium with some simple-minded bugs, and we can run it. But to
see what is going on, we have to repeatedly do <tt class="docutils literal"><span class="pre">alert(terrarium)</span></tt>, or we
won&#8217;t see what is going on. That is not very practical. It would be nicer if it
would print automatically.  It would also look better if, instead of printing a
thousand terraria below each other, we could update a single printout of the
terrarium. For that second problem, this page conveniently provides a function
called <tt class="docutils literal"><span class="pre">inPlacePrinter</span></tt>. It returns a function like <tt class="docutils literal"><span class="pre">alert</span></tt> which, instead
of adding to the output, replaces its previous output.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">printHere</span> <span class="o">=</span> <span class="nx">inPlacePrinter</span><span class="p">();</span>
<span class="nx">printHere</span><span class="p">(</span><span class="s2">&quot;Now you see it.&quot;</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">partial</span><span class="p">(</span><span class="nx">printHere</span><span class="p">,</span> <span class="s2">&quot;Now you don&#39;t.&quot;</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>
</pre></div>
</div>
<p>To cause the terrarium to be re-printed every time it changes, we can modify
the <tt class="docutils literal"><span class="pre">step</span></tt> method as follows:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">forEach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">listActingCreatures</span><span class="p">(),</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">processCreature</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onStep</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onStep</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now, when an <tt class="docutils literal"><span class="pre">onStep</span></tt> property has been added to a terrarium, it will be
called on every step.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">terrarium</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Terrarium</span><span class="p">(</span><span class="nx">thePlan</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">onStep</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">(</span><span class="nx">inPlacePrinter</span><span class="p">(),</span> <span class="nx">terrarium</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</pre></div>
</div>
<p>Note the use of <tt class="docutils literal"><span class="pre">partial</span></tt> â it produces an in-place printer applied to the
terrarium. Such a printer only takes one argument, so after partially applying
it there are no arguments left, and it becomes a function of zero arguments.
That is exactly what we need for the <tt class="docutils literal"><span class="pre">onStep</span></tt> property.</p>
<p>Don&#8217;t forget to stop the terrarium when it is no longer interesting (which
should be pretty soon), so that it does not keep wasting your computer&#8217;s
resources:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">terrarium</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</pre></div>
</div>
<hr class="docutils" />
<p>But who wants a terrarium with just one kind of bug, and a stupid bug at that?
Not me. It would be nice if we could add different kinds of bugs. Fortunately,
all we have to is to make the <tt class="docutils literal"><span class="pre">elementFromCharacter</span></tt> function more general.
Right now it contains three cases which are typed in directly, or &#8220;hard-coded&#8221;:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">elementFromCharacter</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">wall</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">StupidBug</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first two cases we can leave intact, but the last one is way too specific.
A better approach would be to store the characters and the corresponding
bug-constructors in a dictionary, and look for them there:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">creatureTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dictionary</span><span class="p">();</span>
<span class="nx">creatureTypes</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">character</span><span class="p">,</span> <span class="nx">constructor</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">elementFromCharacter</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">character</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">wall</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">creatureTypes</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">character</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="nx">creatureTypes</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">character</span><span class="p">))();</span>
    <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unknown character: &quot;</span> <span class="o">+</span> <span class="nx">character</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note how the <tt class="docutils literal"><span class="pre">register</span></tt> method is added to <tt class="docutils literal"><span class="pre">creatureTypes</span></tt> â this is a
dictionary object, but there is no reason why it shouldn&#8217;t support an
additional method. This method looks up the character associated with a
constructor, and stores it in the dictionary. It should only be called on
constructors whose prototype does actually have a <tt class="docutils literal"><span class="pre">character</span></tt> property.</p>
<p><tt class="docutils literal"><span class="pre">elementFromCharacter</span></tt> now looks up the character it is given in
<tt class="docutils literal"><span class="pre">creatureTypes</span></tt>, and raises an exception when it comes across an unknown
character.</p>
<hr class="docutils" />
<p>Here is a new bug type, and the call to register its character in
<tt class="docutils literal"><span class="pre">creatureTypes</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">BouncingBug</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">direction</span> <span class="o">=</span> <span class="s2">&quot;ne&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">BouncingBug</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">act</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">surroundings</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">direction</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">direction</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">direction</span> <span class="o">==</span> <span class="s2">&quot;ne&quot;</span> <span class="o">?</span> <span class="s2">&quot;sw&quot;</span> <span class="o">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">direction</span><span class="p">};</span>
<span class="p">};</span>
<span class="nx">BouncingBug</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span><span class="p">;</span>

<span class="nx">creatureTypes</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">BouncingBug</span><span class="p">);</span>
</pre></div>
</div>
<p>Can you figure out what it does?</p>
<hr class="docutils" />
<p>So, let us test out our new bugs:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">newPlan</span> <span class="o">=</span>
    <span class="p">[</span><span class="s2">&quot;############################&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                      #####&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#    ##                 ####&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#   ####     ~ ~          ##&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#    ##       ~            #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                          #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                ###       #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#               #####      #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                ###       #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;# %        ###        %    #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#        #######           #&quot;</span><span class="p">,</span>
     <span class="s2">&quot;############################&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">terrarium</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Terrarium</span><span class="p">(</span><span class="nx">newPlan</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">onStep</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">(</span><span class="nx">inPlacePrinter</span><span class="p">(),</span> <span class="nx">terrarium</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</pre></div>
</div>
<p>Notice the bouncing bugs bouncing off the drunk ones? Pure drama.  Anyway, when
you are done watching this fascinating show, shut it down:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">terrarium</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</pre></div>
</div>
<hr class="docutils" />
<p>We now have two kinds of objects that both have an <tt class="docutils literal"><span class="pre">act</span></tt> method and a
<tt class="docutils literal"><span class="pre">character</span></tt> property. Because they share these traits, the terrarium can
approach them in the same way. This allows us to have all kinds of bugs,
without changing anything about the terrarium code. This technique is called
polymorphism, and it is arguably the most powerful aspect of object-oriented
programming.</p>
<p>The basic idea of polymorphism is that when a piece of code is written to work
with objects that have a certain interface, any kind of object that happens to
support this interface can be plugged into the code, and it will just work. We
already saw simple examples of this, like the <tt class="docutils literal"><span class="pre">toString</span></tt> method on objects.
All objects that have a meaningful <tt class="docutils literal"><span class="pre">toString</span></tt> method can be given to
<tt class="docutils literal"><span class="pre">print</span></tt> and other functions that need to convert values to strings, and the
correct string will be produced, no matter how their <tt class="docutils literal"><span class="pre">toString</span></tt> method
chooses to build this string.</p>
<p>Similarly, <tt class="docutils literal"><span class="pre">forEach</span></tt> works on both real arrays and the pseudo-arrays found in
the <tt class="docutils literal"><span class="pre">arguments</span></tt> variable, because all it needs is a <tt class="docutils literal"><span class="pre">length</span></tt> property and
properties called <tt class="docutils literal"><span class="pre">0</span></tt>, <tt class="docutils literal"><span class="pre">1</span></tt>, and so on, for the elements of the array.</p>
<hr class="docutils" />
<p>To make life in the terrarium more life-like, we will add to it the concepts of
food and reproduction. Each living thing in the terrarium gets a new property,
<tt class="docutils literal"><span class="pre">energy</span></tt>, which is reduced by performing actions, and increased by eating
things. When it has enough energy, a thing can reproduce (to keep things
reasonably simple, the creatures in our terrarium reproduce asexually, all by
themselves) generating a new creature of the same kind.</p>
<p>If there are only bugs, wasting energy by moving around and eating each other,
a terrarium will soon succumb to the forces of entropy, run out of energy, and
become a lifeless wasteland. To prevent this from happening (too quickly, at
least), we add lichen to the terrarium. Lichen do not move, they just use
photo-synthesis to gather energy, and reproduce.</p>
<p>To make this work, we will need a terrarium with a different
<tt class="docutils literal"><span class="pre">processCreature</span></tt> method. We could just replace the method of to the
<tt class="docutils literal"><span class="pre">Terrarium</span></tt> prototype, but we have become very attached to the simulation of
the bouncing and drunk bugs, and we would hate to break our old terrarium.</p>
<p>What we can do is create a new constructor, <tt class="docutils literal"><span class="pre">LifeLikeTerrarium</span></tt>, whose
prototype is based on the <tt class="docutils literal"><span class="pre">Terrarium</span></tt> prototype, but which has a different
<tt class="docutils literal"><span class="pre">processCreature</span></tt> method.</p>
<hr class="docutils" />
<p>There are a few ways to do this. We could go over the properties of
<tt class="docutils literal"><span class="pre">Terrarium.prototype</span></tt>, and add them one by one to
<tt class="docutils literal"><span class="pre">LifeLikeTerrarium.prototype</span></tt>. This is easy to do, and in some cases it is
the best solution, but in this case there is a cleaner way. If we make the old
prototype object the prototype of the new prototype object (you may have to
re-read that a few times), it will automatically have all its properties.</p>
<p>Unfortunately, JavaScript does not have a straightforward way to create an
object whose prototype is a certain other object. It is possible to write a
function that does this, though, by using the following trick:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">OneShotConstructor</span><span class="p">(){}</span>
    <span class="nx">OneShotConstructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">OneShotConstructor</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function uses an empty one-shot constructor, whose prototype is the given
object. When using <tt class="docutils literal"><span class="pre">new</span></tt> on this constructor, it will create a new object
based on the given object.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">LifeLikeTerrarium</span><span class="p">(</span><span class="nx">plan</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Terrarium</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">plan</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">LifeLikeTerrarium</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">Terrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">LifeLikeTerrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">LifeLikeTerrarium</span><span class="p">;</span>
</pre></div>
</div>
<p>The new constructor doesn&#8217;t need to do anything different from the old one, so
it just calls the old one on the <tt class="docutils literal"><span class="pre">this</span></tt> object. We also have to restore the
<tt class="docutils literal"><span class="pre">constructor</span></tt> property in the new prototype, or it would claim its
constructor is <tt class="docutils literal"><span class="pre">Terrarium</span></tt> (which, of course, is only really a problem when
we make use of this property, which we don&#8217;t).</p>
<hr class="docutils" />
<p>It is now possible to replace some of the methods of the <tt class="docutils literal"><span class="pre">LifeLikeTerrarium</span></tt>
object, or add new ones. We have based a new object type on an old one, which
saved us the work of re-writing all the methods which are the same in
<tt class="docutils literal"><span class="pre">Terrarium</span></tt> and <tt class="docutils literal"><span class="pre">LifeLikeTerrarium</span></tt>. This technique is called
&#8220;inheritance&#8221;. The new type inherits the properties of the old type. In most
cases, this means the new type will still support the interface of the old
type, though it might also support a few methods that the old type does not
have. This way, objects of the new type can be (polymorphically) used in all
the places where objects of the old type could be used.</p>
<p>In most programming languages with explicit support for object-oriented
programming, inheritance is a very straightforward thing. In JavaScript, the
language doesn&#8217;t really specify a simple way to do it. Because of this,
JavaScript programmers have invented many different approaches to inheritance.
Unfortunately, none of them is quite perfect. Fortunately, such a broad range
of approaches allows a programmer to choose the most suitable one for the
problem he is solving, and allows certain tricks that would be utterly
impossible in other languages.</p>
<p>At the end of this chapter, I will show a few other ways to do inheritance, and
the issues they have.</p>
<hr class="docutils" />
<p>Here is the new <tt class="docutils literal"><span class="pre">processCreature</span></tt> method. It is big.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">LifeLikeTerrarium</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processCreature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">creature</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">surroundings</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">listSurroundings</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">act</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">valueAtTarget</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">directions</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">direction</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">direction</span> <span class="o">=</span> <span class="nx">directions</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">direction</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">maybe</span> <span class="o">=</span> <span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">direction</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">isInside</span><span class="p">(</span><span class="nx">maybe</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">target</span> <span class="o">=</span> <span class="nx">maybe</span><span class="p">;</span>
            <span class="nx">valueAtTarget</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">valueAt</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">valueAtTarget</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">moveValue</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
            <span class="nx">creature</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
            <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;eat&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">valueAtTarget</span> <span class="o">&amp;&amp;</span> <span class="nx">valueAtTarget</span><span class="p">.</span><span class="nx">energy</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
            <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">+=</span> <span class="nx">valueAtTarget</span><span class="p">.</span><span class="nx">energy</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;photosynthese&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;reproduce&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">valueAtTarget</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">species</span> <span class="o">=</span> <span class="nx">characterFromElement</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">baby</span> <span class="o">=</span> <span class="nx">elementFromCharacter</span><span class="p">(</span><span class="nx">species</span><span class="p">);</span>
            <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">-=</span> <span class="nx">baby</span><span class="p">.</span><span class="nx">energy</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">baby</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;wait&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">-=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unsupported action: &quot;</span> <span class="o">+</span> <span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">energy</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">setValueAt</span><span class="p">(</span><span class="nx">creature</span><span class="p">.</span><span class="nx">point</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The function still starts by asking the creature for an action.  Then, if the
action has a <tt class="docutils literal"><span class="pre">direction</span></tt> property, it immediately computes which point on the
grid this direction points to and which value is currently sitting there. Three
of the five supported actions need to know this, and the code would be even
uglier if they all computed it separately. If there is no <tt class="docutils literal"><span class="pre">direction</span></tt>
property, or an invalid one, it leaves the variables <tt class="docutils literal"><span class="pre">target</span></tt> and
<tt class="docutils literal"><span class="pre">valueAtTarget</span></tt> undefined.</p>
<p>After this, it goes over all the actions. Some actions require additional
checking before they are executed, this is done with a separate <tt class="docutils literal"><span class="pre">if</span></tt> so that
if a creature, for example, tries to walk through a wall, we do not generate an
<tt class="docutils literal"><span class="pre">&quot;Unsupported</span> <span class="pre">action&quot;</span></tt> exception.</p>
<p>Note that, in the <tt class="docutils literal"><span class="pre">&quot;reproduce&quot;</span></tt> action, the parent creature loses twice the
energy that the newborn creature gets (childbearing is not easy), and the new
creature is only placed on the grid if the parent had enough energy to produce
it.</p>
<p>After the action has been performed, we check whether the creature is out of
energy. If it is, it dies, and we remove it.</p>
<hr class="docutils" />
<p>Lichen is not a very complex organism. We will use the character <tt class="docutils literal"><span class="pre">&quot;*&quot;</span></tt> to
represent it. Make sure you have defined the <tt class="docutils literal"><span class="pre">randomElement</span></tt> function from
exercise 6, because it is used again here.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Lichen</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">energy</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Lichen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">act</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">emptySpace</span> <span class="o">=</span> <span class="nx">findDirections</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">energy</span> <span class="o">&gt;=</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span> <span class="nx">emptySpace</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;reproduce&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">randomElement</span><span class="p">(</span><span class="nx">emptySpace</span><span class="p">)};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">energy</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;photosynthese&quot;</span><span class="p">};</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;wait&quot;</span><span class="p">};</span>
<span class="p">};</span>
<span class="nx">Lichen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">character</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">;</span>

<span class="nx">creatureTypes</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">Lichen</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">findDirections</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">,</span> <span class="nx">wanted</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">directions</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">surroundings</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">==</span> <span class="nx">wanted</span><span class="p">)</span>
            <span class="nx">found</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lichen do not grow bigger than 20 energy, or they would get <em>huge</em> when they
are surrounded by other lichen and have no room to reproduce.</p>
<hr class="docutils" />
<p>And try it out.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">lichenPlan</span> <span class="o">=</span>
    <span class="p">[</span><span class="s2">&quot;############################&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                     ######&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#    ***                **##&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#   *##**         **  c  *##&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#    ***     c    ##**    *#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#       c         ##***   *#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#                 ##**    *#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#   c       #*            *#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#*          #**       c   *#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#***        ##**    c    **#&quot;</span><span class="p">,</span>
     <span class="s2">&quot;#*****     ###***       *###&quot;</span><span class="p">,</span>
     <span class="s2">&quot;############################&quot;</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">terrarium</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LifeLikeTerrarium</span><span class="p">(</span><span class="nx">lichenPlan</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">onStep</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">(</span><span class="nx">inPlacePrinter</span><span class="p">(),</span> <span class="nx">terrarium</span><span class="p">);</span>
<span class="nx">terrarium</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</pre></div>
</div>
<p>Most likely, you will see the lichen quickly over-grow a large part of the
terrarium, after which the abundance of food makes the eaters so numerous that
they wipe out all the lichen, and thus themselves. Ah, tragedy of nature.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">terrarium</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Having the inhabitants of your terrarium go extinct after a few minutes is kind
of depressing. To deal with this, we have to teach our lichen-eaters about
long-term sustainable farming. By making them only eat if they see at least two
lichen nearby, no matter how hungry they are, they will never exterminate the
lichen. This requires some discipline, but the result is a biotope that does
not destroy itself. Here is a new <tt class="docutils literal"><span class="pre">act</span></tt> method â the only change is that it
now only eats when <tt class="docutils literal"><span class="pre">lichen.length</span></tt> is at least two.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">LichenEater</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">act</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">emptySpace</span> <span class="o">=</span> <span class="nx">findDirections</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">lichen</span> <span class="o">=</span> <span class="nx">findDirections</span><span class="p">(</span><span class="nx">surroundings</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">energy</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="nx">emptySpace</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;reproduce&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">randomElement</span><span class="p">(</span><span class="nx">emptySpace</span><span class="p">)};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lichen</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;eat&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">randomElement</span><span class="p">(</span><span class="nx">lichen</span><span class="p">)};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">emptySpace</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">randomElement</span><span class="p">(</span><span class="nx">emptySpace</span><span class="p">)};</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;wait&quot;</span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Run the above <tt class="docutils literal"><span class="pre">lichenPlan</span></tt> terrarium again, and see how it goes.  Unless you
are very lucky, the lichen-eaters will probably still go extinct after a while,
because, in a time of mass starvation, they crawl aimlessly back and forth
through empty space, instead of finding the lichen that is sitting just around
the corner.</p>
<hr class="docutils" />
<p>That concludes our discussion of terraria. The rest of the chapter is devoted
to a more in-depth look at inheritance, and the problems related to inheritance
in JavaScript.</p>
<hr class="docutils" />
<p>First, some theory. Students of object-oriented programming can often be heard
having lengthy, subtle discussions about correct and incorrect uses of
inheritance. It is important to bear in mind that inheritance, in the end, is
just a trick that allows lazy programmers to write less code.  Thus, the
question of whether inheritance is being used correctly boils down to the
question of whether the resulting code works correctly and avoids useless
repetitions. Still, the principles used by these students provide a good way to
start thinking about inheritance.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Laziness, for a programmer, is not necessarily a sin. The kind of people
who will industriously do the same thing over and over again tend to make
great assembly-line workers and lousy programmers.</p>
</div>
<p>Inheritance is the creation of a new type of objects, the &#8220;sub-type&#8221;, based on
an existing type, the &#8220;super-type&#8221;. The sub-type starts with all the properties
and methods of the super-type, it inherits them, and then modifies a few of
these, and optionally adds new ones. Inheritance is best used when the thing
modelled by the sub-type can be said to <em>be</em> an object of the super-type.</p>
<p>Thus, a <tt class="docutils literal"><span class="pre">Piano</span></tt> type could be a sub-type of an <tt class="docutils literal"><span class="pre">Instrument</span></tt> type, because a
piano <em>is</em> an instrument. Because a piano has a whole array of keys, one might
be tempted to make <tt class="docutils literal"><span class="pre">Piano</span></tt> a sub-type of <tt class="docutils literal"><span class="pre">Array</span></tt>, but a piano <em>is</em> no
array, and implementing it like that is bound to lead to all kinds of
silliness. For example, a piano also has pedals. Why would <tt class="docutils literal"><span class="pre">piano[0]</span></tt> give me
the first key, and not the first pedal? The situation is, of course, that a
piano <em>has</em> keys, so it would be better to give it a property <tt class="docutils literal"><span class="pre">keys</span></tt>, and
possibly another property <tt class="docutils literal"><span class="pre">pedals</span></tt>, both holding arrays.</p>
<p>It is possible for a sub-type to be the super-type of yet another sub-type.
Some problems are best solved by building a complex family tree of types. You
have to take care not to get too inheritance-happy, though. Overuse of
inheritance is a great way to make a program into a big ugly mess.</p>
<hr class="docutils" />
<p>The working of the <tt class="docutils literal"><span class="pre">new</span></tt> keyword and the <tt class="docutils literal"><span class="pre">prototype</span></tt> property of
constructors suggest a certain way of using objects. For simple objects, such
as the terrarium-creatures, this way works rather well. Unfortunately, when a
program starts to make serious use of inheritance, this approach to objects
quickly becomes clumsy.  Adding some functions to take care of common
operations can make things a little smoother. Many people define, for example,
<tt class="docutils literal"><span class="pre">inherit</span></tt> and <tt class="docutils literal"><span class="pre">method</span></tt> methods on objects.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inherit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">baseConstructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">baseConstructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">StrangeArray</span><span class="p">(){}</span>
<span class="nx">StrangeArray</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span><span class="nb">Array</span><span class="p">);</span>
<span class="nx">StrangeArray</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">strange</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StrangeArray</span><span class="p">();</span>
<span class="nx">strange</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">strange</span><span class="p">);</span>
</pre></div>
</div>
<p>If you search the web for the words &#8220;JavaScript&#8221; and &#8220;inheritance&#8221;, you will
come across scores of different variations on this, some of them quite a lot
more complex and clever than the above.</p>
<p>Note how the <tt class="docutils literal"><span class="pre">push</span></tt> method written here uses the <tt class="docutils literal"><span class="pre">push</span></tt> method from the
prototype of its parent type. This is something that is done often when using
inheritance â a method in the sub-type internally uses a method of the
super-type, but extends it somehow.</p>
<hr class="docutils" />
<p>The biggest problem with this basic approach is the duality between
constructors and prototypes. Constructors take a very central role, they are
the things that give an object type its name, and when you need to get at a
prototype, you have to go to the constructor and take its <tt class="docutils literal"><span class="pre">prototype</span></tt>
property.</p>
<p>Not only does this lead to a <em>lot</em> of typing (<tt class="docutils literal"><span class="pre">&quot;prototype&quot;</span></tt> is 9 letters), it
is also confusing. We had to write an empty, useless constructor for
<tt class="docutils literal"><span class="pre">StrangeArray</span></tt> in the example above. Quite a few times, I have found myself
accidentally adding methods to a constructor instead of its prototype, or
trying to call <tt class="docutils literal"><span class="pre">Array.slice</span></tt> when I really meant <tt class="docutils literal"><span class="pre">Array.prototype.slice</span></tt>.
As far as I am concerned, the prototype itself is the most important
aspect of an object type, and the constructor is just an extension of that, a
special kind of method.</p>
<hr class="docutils" />
<p>With a few simple helper methods added to <tt class="docutils literal"><span class="pre">Object.prototype</span></tt>, it is possible
to create an alternative approach to objects and inheritance. In this approach,
a type is represented by its prototype, and we will use capitalised variables
to store these prototypes. When it needs to do any &#8220;constructing&#8221; work, this is
done by a method called <tt class="docutils literal"><span class="pre">construct</span></tt>. We add a method called <tt class="docutils literal"><span class="pre">create</span></tt> to the
<tt class="docutils literal"><span class="pre">Object</span></tt> prototype, which is used in place of the <tt class="docutils literal"><span class="pre">new</span></tt> keyword. It clones
the object, and calls its <tt class="docutils literal"><span class="pre">construct</span></tt> method, if there is such a method,
giving it the arguments that were passed to <tt class="docutils literal"><span class="pre">create</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">object</span><span class="p">.</span><span class="nx">construct</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
        <span class="nx">object</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Inheritance can be done by cloning a prototype object and adding or replacing
some of its properties. We also provide a convenient shorthand for this, an
<tt class="docutils literal"><span class="pre">extend</span></tt> method, which clones the object it is applied to and adds to this
clone the properties in the object that it is given as an argument.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="nx">forEachIn</span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In a case where it is not safe to mess with the <tt class="docutils literal"><span class="pre">Object</span></tt> prototype, these can
of course be implemented as regular (non-method) functions.</p>
<hr class="docutils" />
<p>An example. If you are old enough, you may at one time have played a &#8220;text
adventure&#8221; game, where you move through a virtual world by typing commands, and
get textual descriptions of the things around you and the actions you perform.
Now those were games!</p>
<p>We could write the prototype for an item in such a game like this.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;it is &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">kick</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;klunk!&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">take</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;you can not lift &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">lantern</span> <span class="o">=</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;the brass lantern&quot;</span><span class="p">);</span>
<span class="nx">lantern</span><span class="p">.</span><span class="nx">kick</span><span class="p">();</span>
</pre></div>
</div>
<p>Inherit from it like this...</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">DetailedItem</span> <span class="o">=</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">details</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Item</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">details</span> <span class="o">=</span> <span class="nx">details</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;you see &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">details</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">giantSloth</span> <span class="o">=</span> <span class="nx">DetailedItem</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
    <span class="s2">&quot;the giant sloth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it is quietly hanging from a tree, munching leaves&quot;</span><span class="p">);</span>
<span class="nx">giantSloth</span><span class="p">.</span><span class="nx">inspect</span><span class="p">();</span>
</pre></div>
</div>
<p>Leaving out the compulsory <tt class="docutils literal"><span class="pre">prototype</span></tt> part makes things like calling
<tt class="docutils literal"><span class="pre">Item.construct</span></tt> from <tt class="docutils literal"><span class="pre">DetailedItem</span></tt>&#8216;s constructor slightly simpler. Note
that it would be a bad idea to just do <tt class="docutils literal"><span class="pre">this.name</span> <span class="pre">=</span> <span class="pre">name</span></tt> in
<tt class="docutils literal"><span class="pre">DetailedItem.construct</span></tt>. This duplicates a line. Sure, duplicating the line
is shorter than calling the <tt class="docutils literal"><span class="pre">Item.construct</span></tt> function, but if we end up
adding something to this constructor later, we have to add it in two places.</p>
<hr class="docutils" />
<p>Most of the time, a sub-type&#8217;s constructor should start by calling the
constructor of the super-type. This way, it starts with a valid object of the
super-type, which it can then extend. In this new approach to prototypes, types
that need no constructor can leave it out. They will automatically inherit the
constructor of their super-type.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">SmallItem</span> <span class="o">=</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">kick</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; flies across the room.&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">take</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// (imagine some code that moves the item to your pocket here)</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;you take &quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">pencil</span> <span class="o">=</span> <span class="nx">SmallItem</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;the red pencil&quot;</span><span class="p">);</span>
<span class="nx">pencil</span><span class="p">.</span><span class="nx">take</span><span class="p">();</span>
</pre></div>
</div>
<p>Even though <tt class="docutils literal"><span class="pre">SmallItem</span></tt> does not define its own constructor, creating it with
a <tt class="docutils literal"><span class="pre">name</span></tt> argument works, because it inherited the constructor from the
<tt class="docutils literal"><span class="pre">Item</span></tt> prototype.</p>
<hr class="docutils" />
<p>JavaScript has an operator called <tt class="docutils literal"><span class="pre">instanceof</span></tt>, which can be used to
determine whether an object is based on a certain prototype. You give it the
object on the left hand side, and a constructor on the right hand side, and it
returns a boolean, <tt class="docutils literal"><span class="pre">true</span></tt> if the constructor&#8217;s <tt class="docutils literal"><span class="pre">prototype</span></tt> property is the
direct or indirect prototype of the object, and <tt class="docutils literal"><span class="pre">false</span></tt> otherwise.</p>
<p>When you are not using regular constructors, using this operator becomes rather
clumsy â it expects a constructor function as its second argument, but we only
have prototypes. A trick similar to the <tt class="docutils literal"><span class="pre">clone</span></tt> function can be used to get
around it: We use a &#8220;fake constructor&#8221;, and apply <tt class="docutils literal"><span class="pre">instanceof</span></tt> to it.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasPrototype</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">DummyConstructor</span><span class="p">()</span> <span class="p">{}</span>
    <span class="nx">DummyConstructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">DummyConstructor</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">alert</span><span class="p">(</span><span class="nx">pencil</span><span class="p">.</span><span class="nx">hasPrototype</span><span class="p">(</span><span class="nx">Item</span><span class="p">));</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">pencil</span><span class="p">.</span><span class="nx">hasPrototype</span><span class="p">(</span><span class="nx">DetailedItem</span><span class="p">));</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Next, we want to make a small item that has a detailed description.  It seems
like this item would have to inherit both from <tt class="docutils literal"><span class="pre">DetailedItem</span></tt> and
<tt class="docutils literal"><span class="pre">SmallItem</span></tt>. JavaScript does not allow an object to have multiple prototypes,
and even if it did, the problem would not be quite that easy to solve. For
example, if <tt class="docutils literal"><span class="pre">SmallItem</span></tt> would, for some reason, also define an <tt class="docutils literal"><span class="pre">inspect</span></tt>
method, which <tt class="docutils literal"><span class="pre">inspect</span></tt> method should the new prototype use?</p>
<p>Deriving an object type from more than one parent type is called multiple
inheritance. Some languages chicken out and forbid it altogether, others define
complicated schemes for making it work in a well-defined and practical way. It
is possible to implement a decent multiple-inheritance framework in JavaScript.
In fact there are, as usual, multiple good approaches to this. But they all are
too complex to be discussed here. Instead, I will show a very simple approach
which suffices in most cases.</p>
<hr class="docutils" />
<p>A mix-in is a specific kind of prototype which can be &#8216;mixed into&#8217; other
prototypes. <tt class="docutils literal"><span class="pre">SmallItem</span></tt> can be seen as such a prototype. By copying its
<tt class="docutils literal"><span class="pre">kick</span></tt> and <tt class="docutils literal"><span class="pre">take</span></tt> methods into another prototype, we mix smallness into
this prototype.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">mixInto</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">mixIn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">forEachIn</span><span class="p">(</span><span class="nx">mixIn</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">object</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">SmallDetailedItem</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">DetailedItem</span><span class="p">);</span>
<span class="nx">mixInto</span><span class="p">(</span><span class="nx">SmallDetailedItem</span><span class="p">,</span> <span class="nx">SmallItem</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">deadMouse</span> <span class="o">=</span> <span class="nx">SmallDetailedItem</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
    <span class="s2">&quot;Fred the mouse&quot;</span><span class="p">,</span>
    <span class="s2">&quot;he is dead&quot;</span><span class="p">);</span>
<span class="nx">deadMouse</span><span class="p">.</span><span class="nx">inspect</span><span class="p">();</span>
<span class="nx">deadMouse</span><span class="p">.</span><span class="nx">kick</span><span class="p">();</span>
</pre></div>
</div>
<p>Remember that <tt class="docutils literal"><span class="pre">forEachIn</span></tt> only goes over the object&#8217;s <em>own</em> properties, so it
will copy <tt class="docutils literal"><span class="pre">kick</span></tt> and <tt class="docutils literal"><span class="pre">take</span></tt>, but not the constructor that <tt class="docutils literal"><span class="pre">SmallItem</span></tt>
inherited from <tt class="docutils literal"><span class="pre">Item</span></tt>.</p>
<hr class="docutils" />
<p>Mixing prototypes gets more complex when the mix-in has a constructor, or when
some of its methods &#8216;clash&#8217; with methods in the prototype that it is mixed
into. Sometimes, it is workable to do a &#8220;manual mix-in&#8221;. Say we have a
prototype <tt class="docutils literal"><span class="pre">Monster</span></tt>, which has its own constructor, and we want to mix that
with <tt class="docutils literal"><span class="pre">DetailedItem</span></tt>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Monster</span> <span class="o">=</span> <span class="nx">Item</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">dangerous</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Item</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dangerous</span> <span class="o">=</span> <span class="nx">dangerous</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">kick</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dangerous</span><span class="p">)</span>
            <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; bites your head off.&quot;</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot; runs away, weeping.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">DetailedMonster</span> <span class="o">=</span> <span class="nx">DetailedItem</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">dangerous</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">DetailedItem</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">description</span><span class="p">);</span>
        <span class="nx">Monster</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">dangerous</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">kick</span><span class="o">:</span> <span class="nx">Monster</span><span class="p">.</span><span class="nx">kick</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">giantSloth</span> <span class="o">=</span> <span class="nx">DetailedMonster</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
    <span class="s2">&quot;the giant sloth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it is quietly hanging from a tree, munching leaves&quot;</span><span class="p">,</span>
    <span class="kc">true</span><span class="p">);</span>
<span class="nx">giantSloth</span><span class="p">.</span><span class="nx">kick</span><span class="p">();</span>
</pre></div>
</div>
<p>But note that this causes <tt class="docutils literal"><span class="pre">Item</span></tt> constructor to be called twice when creating
a <tt class="docutils literal"><span class="pre">DetailedMonster</span></tt> â once through the <tt class="docutils literal"><span class="pre">DetailedItem</span></tt> constructor, and once
through the <tt class="docutils literal"><span class="pre">Monster</span></tt> constructor. In this case there is not much harm done,
but there are situations where this would cause a problem.</p>
<hr class="docutils" />
<p>But don&#8217;t let those complications discourage you from making use of
inheritance. Multiple inheritance, though extremely useful in some situations,
can be safely ignored most of the time. This is why languages like Java get
away with forbidding multiple inheritance.  And if, at some point, you find
that you really need it, you can search the web, do some research, and figure
out an approach that works for your situation.</p>
<p>Now that I think about it, JavaScript would probably be a great environment for
building a text adventure. The ability to change the behaviour of objects at
will, which is what prototypical inheritance gives us, is very well suited for
this. If you have an object <tt class="docutils literal"><span class="pre">hedgehog</span></tt>, which has the unique habit of rolling
up when it is kicked, you can just change its <tt class="docutils literal"><span class="pre">kick</span></tt> method.</p>
<p>Unfortunately, the text adventure went the way of the vinyl record and, while
once very popular, is nowadays only played by a small population of
<a class="reference external" href="http://groups.google.com/group/rec.arts.int-fiction/topics">enthusiasts</a>.</p>
<div class="section" id="exercises">
<h2>11.1. Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="exercises/ch11/ch11s01.html#ch11s01"><em>Chapter 11 Exercise Set 1</em></a></li>
</ul>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ch12.html" title="12. Modularity"
             >next</a> |</li>
        <li class="right" >
          <a href="ch10.html" title="10. Searching"
             >previous</a> |</li>
        <li><a href="index.html">A Modern Introduction to Programming with JavaScript and jQuery</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="copyright.html">Copyright</a> 2013, Marijn Haverbeke and Jeffrey Elkner.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>